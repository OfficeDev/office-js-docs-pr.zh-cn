---
title: 在 Office 加载项中授权外部服务
description: 获得对非 Microsoft 数据的授权，如 Google、Facebook、LinkedIn、SalesForce 和使用 OAuth 2.0、授权代码和隐式流的 GitHub。
ms.date: 08/07/2019
localization_priority: Normal
ms.openlocfilehash: e58aba29563a3bcf173a4f76d7e3788b79f09049
ms.sourcegitcommit: 883f71d395b19ccfc6874a0d5942a7016eb49e2c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/09/2021
ms.locfileid: "53350055"
---
# <a name="authorize-external-services-in-your-office-add-in"></a><span data-ttu-id="31cf0-103">在 Office 加载项中授权外部服务</span><span class="sxs-lookup"><span data-stu-id="31cf0-103">Authorize external services in your Office Add-in</span></span>

<span data-ttu-id="31cf0-104">热门在线服务（包括 Microsoft 365、Google、Facebook、LinkedIn、SalesForce 和 GitHub）允许用户在其他应用程序中访问其帐户。</span><span class="sxs-lookup"><span data-stu-id="31cf0-104">Popular online services, including Microsoft 365, Google, Facebook, LinkedIn, SalesForce, and GitHub, let developers give users access to their accounts in other applications.</span></span> <span data-ttu-id="31cf0-105">这样，便可在 Office 加载项中添加这些服务。</span><span class="sxs-lookup"><span data-stu-id="31cf0-105">This gives you the ability to include these services in your Office Add-in.</span></span>

> [!NOTE]
> <span data-ttu-id="31cf0-106">本文的其余部分涉及的是访问非 Microsoft 服务。</span><span class="sxs-lookup"><span data-stu-id="31cf0-106">The remainder of this article is about accessing non-Microsoft services.</span></span> <span data-ttu-id="31cf0-107">有关访问 Microsoft Graph (包括Microsoft 365) ，请参阅使用[SSO](overview-authn-authz.md#access-to-microsoft-graph-with-sso)访问 Microsoft Graph和访问 Microsoft Graph[不含 SSO。](overview-authn-authz.md#access-to-microsoft-graph-without-sso)</span><span class="sxs-lookup"><span data-stu-id="31cf0-107">For information about accessing Microsoft Graph (including Microsoft 365), see [Access to Microsoft Graph with SSO](overview-authn-authz.md#access-to-microsoft-graph-with-sso) and [Access to Microsoft Graph without SSO](overview-authn-authz.md#access-to-microsoft-graph-without-sso).</span></span>

<span data-ttu-id="31cf0-p103">授权 Web 应用访问在线服务的行业标准框架为 **OAuth 2.0**。大多数情况下，无需了解框架的详细工作原理，即可在加载项中使用它。许多库都可用来化繁为简。</span><span class="sxs-lookup"><span data-stu-id="31cf0-p103">The industry standard framework for enabling web application access to an online service is **OAuth 2.0**. In most situations, you don't need to know the details of how the framework works to use it in your add-in. Many libraries are available that simplify the details for you.</span></span>

<span data-ttu-id="31cf0-111">OAuth 的基本概念是，应用程序本身可以是一个[安全主体](/windows/security/identity-protection/access-control/security-principals)，就像一个用户或组，拥有其自己的标识和权限集。</span><span class="sxs-lookup"><span data-stu-id="31cf0-111">A fundamental idea of OAuth is that an application can be a [security principal](/windows/security/identity-protection/access-control/security-principals) unto itself, just like a user or a group, with its own identity and set of permissions.</span></span> <span data-ttu-id="31cf0-112">在最典型的应用场景中，当用户在需要联机服务的 Office 加载项中进行操作时，加载项会向服务发送请求，请求为用户帐户提供一组特定权限。</span><span class="sxs-lookup"><span data-stu-id="31cf0-112">In the most typical scenarios, when the user takes an action in the Office Add-in that requires the online service, the add-in sends the service a request for a specific set of permissions to the user's account.</span></span> <span data-ttu-id="31cf0-113">然后，该服务会提示用户向加载项授予这些权限。</span><span class="sxs-lookup"><span data-stu-id="31cf0-113">The service then prompts the user to grant the add-in those permissions.</span></span> <span data-ttu-id="31cf0-114">授予权限之后，该服务会向外接程序发送一个小的编码 *访问令牌*。</span><span class="sxs-lookup"><span data-stu-id="31cf0-114">After the permissions are granted, the service sends the add-in a small encoded *access token*.</span></span> <span data-ttu-id="31cf0-115">外接程序可以通过在其向服务 API 发送的所有请求中包含令牌来使用该服务。</span><span class="sxs-lookup"><span data-stu-id="31cf0-115">The add-in can use the service by including the token in all its requests to the service's APIs.</span></span> <span data-ttu-id="31cf0-116">但外接程序只能在用户授予它的权限范围内进行操作。</span><span class="sxs-lookup"><span data-stu-id="31cf0-116">But the add-in can act only within the permissions that the user granted it.</span></span> <span data-ttu-id="31cf0-117">令牌还会在某个指定时间后过期。</span><span class="sxs-lookup"><span data-stu-id="31cf0-117">The token also expires after a specified time.</span></span>

<span data-ttu-id="31cf0-118">几种称为 *流* 或 *授权类型* 的 OAuth 模式专为不同方案而设计。</span><span class="sxs-lookup"><span data-stu-id="31cf0-118">Several OAuth patterns, called *flows* or *grant types*, are designed for different scenarios.</span></span> <span data-ttu-id="31cf0-119">以下两种模式是最常实现的模式。</span><span class="sxs-lookup"><span data-stu-id="31cf0-119">The following two patterns are the most commonly implemented.</span></span>

- <span data-ttu-id="31cf0-120">**隐式流**：加载项与在线服务的通信是通过客户端 JavaScript 实现。</span><span class="sxs-lookup"><span data-stu-id="31cf0-120">**Implicit flow**: Communication between the add-in and the online service is implemented with client-side JavaScript.</span></span> <span data-ttu-id="31cf0-121">此流常用于单页应用程序 (SPA)。</span><span class="sxs-lookup"><span data-stu-id="31cf0-121">This flow is commonly used in single-page applications (SPAs).</span></span>
- <span data-ttu-id="31cf0-p107">**授权代码流**：加载项 Web 应用与在线服务的通信是 *服务器间* 通信。因此，它是通过服务器端代码实现。</span><span class="sxs-lookup"><span data-stu-id="31cf0-p107">**Authorization Code flow**: Communication is *server-to-server* between your add-in's web application and the online service. So, it is implemented with server-side code.</span></span>

<span data-ttu-id="31cf0-124">OAuth 流旨在保护应用程序的标识和授权。</span><span class="sxs-lookup"><span data-stu-id="31cf0-124">The purpose of an OAuth flow is to secure the identity and authorization of the application.</span></span> <span data-ttu-id="31cf0-125">授权代码流中提供了需要一直隐藏的 *客户端密码*。</span><span class="sxs-lookup"><span data-stu-id="31cf0-125">In the Authorization Code flow, you're provided a *client secret* that needs to be kept hidden.</span></span> <span data-ttu-id="31cf0-126">由于没有服务器端后端的应用程序（如 SPA）无法保护密码，因此建议在 SPA 中使用隐式流。</span><span class="sxs-lookup"><span data-stu-id="31cf0-126">An application that has no server-side backend, such as an SPA, has no way to protect the secret, so we recommend that you use the Implicit flow in SPAs.</span></span>

<span data-ttu-id="31cf0-127">应熟悉隐式流和授权代码流的利与弊。</span><span class="sxs-lookup"><span data-stu-id="31cf0-127">You should be familiar with the pros and cons of the Implicit flow and the Authorization Code flow.</span></span> <span data-ttu-id="31cf0-128">若要详细了解这两个流，请参阅[授权代码流](https://tools.ietf.org/html/rfc6749#section-1.3.1)和[隐式流](https://tools.ietf.org/html/rfc6749#section-1.3.2)。</span><span class="sxs-lookup"><span data-stu-id="31cf0-128">For more information about these two flows, see [Authorization Code](https://tools.ietf.org/html/rfc6749#section-1.3.1) and [Implicit](https://tools.ietf.org/html/rfc6749#section-1.3.2).</span></span>

> [!NOTE]
> <span data-ttu-id="31cf0-p110">还可以视需要使用中间人服务，从而执行授权操作，并将访问令牌传递给加载项。 有关此方案的详细信息，请参阅本文稍后介绍的 **中间人服务** 部分。</span><span class="sxs-lookup"><span data-stu-id="31cf0-p110">You also have the option of using a middleman service to perform authorization and pass the access token to your add-in. For details about this scenario, see the **Middleman services** section later in this article.</span></span>

## <a name="using-the-implicit-flow-in-office-add-ins"></a><span data-ttu-id="31cf0-131">在 Office 外接程序中使用隐式流</span><span class="sxs-lookup"><span data-stu-id="31cf0-131">Using the Implicit flow in Office Add-ins</span></span>

<span data-ttu-id="31cf0-132">若要确定在线服务是否支持隐式流，最好是查阅服务文档。</span><span class="sxs-lookup"><span data-stu-id="31cf0-132">The best way to find out if an online service supports the Implicit flow is to consult the service's documentation.</span></span>

<span data-ttu-id="31cf0-133">有关支持隐式流的库的信息，请参阅本文后面的 **库** 部分。</span><span class="sxs-lookup"><span data-stu-id="31cf0-133">For information about libraries that support the Implicit flow, see the **Libraries** section later in this article.</span></span>

## <a name="using-the-authorization-code-flow-in-office-add-ins"></a><span data-ttu-id="31cf0-134">在 Office 加载项中使用授权代码流</span><span class="sxs-lookup"><span data-stu-id="31cf0-134">Using the Authorization Code flow in Office Add-ins</span></span>

<span data-ttu-id="31cf0-p111">许多库都可用于在各种语言和框架中实现授权代码流。若要详细了解其中某些库，请参阅本文稍后将介绍的 **库** 部分。</span><span class="sxs-lookup"><span data-stu-id="31cf0-p111">Many libraries are available for implementing the Authorization Code flow in various languages and frameworks. For more information about some of these libraries, see the **Libraries** section later in this article.</span></span>

## <a name="libraries"></a><span data-ttu-id="31cf0-137">库</span><span class="sxs-lookup"><span data-stu-id="31cf0-137">Libraries</span></span>

<span data-ttu-id="31cf0-p112">库适用于许多语言和平台，既可用于隐式流，也可用于授权代码流。 一些库是通用的，而另一些库则为在线服务专用。</span><span class="sxs-lookup"><span data-stu-id="31cf0-p112">Libraries are available for many languages and platforms, for both the Implicit flow and the Authorization Code flow. Some libraries are general purpose, while others are for specific online services.</span></span>

<span data-ttu-id="31cf0-p113">**Google**：在 [GitHub.com/Google](https://github.com/google) 中搜索 "auth" 或你语言的相应名称。大部分的相关存储库被命名为 `google-auth-library-[name of language]`。</span><span class="sxs-lookup"><span data-stu-id="31cf0-p113">**Google**: Search [GitHub.com/Google](https://github.com/google) for "auth" or the name of your language. Most of the relevant repos are named `google-auth-library-[name of language]`.</span></span>

<span data-ttu-id="31cf0-142">**Facebook**：在 [Facebook 开发者](https://developers.facebook.com) 中搜索 "library" 或 "sdk"。</span><span class="sxs-lookup"><span data-stu-id="31cf0-142">**Facebook**: Search [Facebook for Developers](https://developers.facebook.com) for "library" or "sdk".</span></span>

<span data-ttu-id="31cf0-p114">**常规 OAuth 2.0**：指向十几种语言库的链接页面由 IETF OAuth 工作组在以下位置进行维护：[OAuth 代码](https://oauth.net/code/)。请注意，其中一些库可用来实现 OAuth 兼容服务。作为外接程序开发人员，你所感兴趣的库就是此页上称为 *客户端* 的库，因为 Web 服务器是 OAuth 兼容服务的客户端。</span><span class="sxs-lookup"><span data-stu-id="31cf0-p114">**General OAuth 2.0**: A page of links to libraries for over a dozen languages is maintained by the IETF OAuth Working Group at: [OAuth Code](https://oauth.net/code/). Note that some of these libraries are for implementing an OAuth compliant service. The libraries of interest to you as a an add-in developer are called *client* libraries on this page because your web server is a client of the OAuth compliant service.</span></span>

## <a name="middleman-services"></a><span data-ttu-id="31cf0-146">中间人服务</span><span class="sxs-lookup"><span data-stu-id="31cf0-146">Middleman services</span></span>

<span data-ttu-id="31cf0-p115">加载项可以使用中间人服务（如 [OAuth.io](https://oauth.io) 或 [Auth0](https://auth0.com)）执行授权。中间人服务可以提供热门在线服务的访问令牌，和/或简化加载项社交登录的启用过程。通过极少量的代码，加载项就可以使用客户端脚本或服务器端代码，连接到中间人服务，然后中间人服务会向加载项发送所需的任何在线服务令牌。所有授权实现代码都位于中间人服务中。</span><span class="sxs-lookup"><span data-stu-id="31cf0-p115">Your add-in can use a middleman service such as [OAuth.io](https://oauth.io) or [Auth0](https://auth0.com) to perform authorization. A middleman service may either provide access tokens for popular online services or simplify the process of enabling social login for your add-in, or both. With very little code, your add-in can use either client-side script or server-side code to connect to the middleman service and it will send your add-in any required tokens for the online service. All of the authorization implementation code is in the middleman service.</span></span> 

<span data-ttu-id="31cf0-151">我们建议外接程序中用于身份验证/授权的 UI 使用对话框 API 打开登录页面。</span><span class="sxs-lookup"><span data-stu-id="31cf0-151">We recommend that the UI for authentication/authorization in your add-in use our Dialog APIs to open a login page.</span></span> <span data-ttu-id="31cf0-152">有关详细信息，请参阅[在身份验证流中使用对话框 API](dialog-api-in-office-add-ins.md#use-the-dialog-apis-in-an-authentication-flow)。</span><span class="sxs-lookup"><span data-stu-id="31cf0-152">See [Use the Dialog APIs in an authentication flow](dialog-api-in-office-add-ins.md#use-the-dialog-apis-in-an-authentication-flow) for more information.</span></span> <span data-ttu-id="31cf0-153">以这种方式打开 Office 对话框时，对话框具有全新和单独的浏览器实例，以及父页面的实例中的 JavaScript 引擎（如外接程序的任务窗格或 FunctionFile）。</span><span class="sxs-lookup"><span data-stu-id="31cf0-153">When you open an Office dialog in this way, the dialog has a completely new and separate instance of the browser and JavaScript engine from the instance in the parent page (e.g., the add-in's task pane or FunctionFile).</span></span> <span data-ttu-id="31cf0-154">一个标记以及可转换为字符串的其他信息被传递回使用名为 `messageParent` 的 API 的父页面。</span><span class="sxs-lookup"><span data-stu-id="31cf0-154">A token, and any other information that can be converted to a string, is passed back to the parent using an API called `messageParent`.</span></span> <span data-ttu-id="31cf0-155">然后父页面可以使用标记对资源进行经过授权的调用。</span><span class="sxs-lookup"><span data-stu-id="31cf0-155">The parent page can then use the token to make authorized calls to the resource.</span></span> <span data-ttu-id="31cf0-156">由于此体系结构，用户必须谨慎地使用中间人服务提供的 API。</span><span class="sxs-lookup"><span data-stu-id="31cf0-156">Because of this architecture, you must be careful how you use the APIs provided by a middleman service.</span></span> <span data-ttu-id="31cf0-157">服务通常会提供 API 集，其中代码创建某种上下文对象，该对象获取标记并使用该标记对资源进行后续调用。</span><span class="sxs-lookup"><span data-stu-id="31cf0-157">Often the service will provide an API set in which your code creates some kind of context object which both gets a token and uses that token in making subsequent calls to the resource.</span></span> <span data-ttu-id="31cf0-158">该服务通常具有单个 API 方法，该方法进行初始调用并创建上下文对象。</span><span class="sxs-lookup"><span data-stu-id="31cf0-158">Often the service has a single API method that makes the initial call *and* creates the context object.</span></span> <span data-ttu-id="31cf0-159">此类对象无法完全字符串化，因此无法从 Office 对话框传递到父页面。</span><span class="sxs-lookup"><span data-stu-id="31cf0-159">An object like this cannot be completely stringified, so it cannot be passed from the Office dialog to the parent page.</span></span> <span data-ttu-id="31cf0-160">通常，中间人服务在较低抽象级别提供第二个 API 集，例如 REST API。</span><span class="sxs-lookup"><span data-stu-id="31cf0-160">Typically, the middleman service provides a second API set, at a lower level of abstraction, such as a REST API.</span></span> <span data-ttu-id="31cf0-161">第二个集将具有从该服务获取标记的 API，以及获取对资源的授权访问权限时将标记传递到服务的其他 API。</span><span class="sxs-lookup"><span data-stu-id="31cf0-161">This second set will have an API that gets a token from the service, and other APIs that pass the token to service when using it to get authorized access to the resource.</span></span> <span data-ttu-id="31cf0-162">需要在此较低抽象级别使用 API，以便在 Office 对话框中获取标记并使用 `messageParent` 将其传递到父页面。</span><span class="sxs-lookup"><span data-stu-id="31cf0-162">You need to work with an API at this lower level of abstraction so that you can get the token in the Office dialog and then use `messageParent` to pass it to the parent page.</span></span> 

## <a name="what-is-cors"></a><span data-ttu-id="31cf0-163">什么是 CORS？</span><span class="sxs-lookup"><span data-stu-id="31cf0-163">What is CORS?</span></span>

<span data-ttu-id="31cf0-p117">CORS 的全称是 [Cross Origin Resource Sharing](https://developer.mozilla.org/docs/Web/HTTP/Access_control_CORS)，即“跨源资源共享”。若要了解如何在加载项内使用 CORS，请参阅[解决 Office 加载项中的同源策略限制](addressing-same-origin-policy-limitations.md)。</span><span class="sxs-lookup"><span data-stu-id="31cf0-p117">CORS stands for [Cross Origin Resource Sharing](https://developer.mozilla.org/docs/Web/HTTP/Access_control_CORS). For information about how to use CORS inside add-ins, see [Addressing same-origin policy limitations in Office Add-ins](addressing-same-origin-policy-limitations.md).</span></span>
