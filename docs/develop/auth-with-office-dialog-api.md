---
title: 使用 Office 对话框 API 进行身份验证和授权
description: 了解如何使用 Office 对话框 API 使用户能够登录到 Google、Facebook、Microsoft 365 以及受 Microsoft 标识平台保护的其他服务。
ms.date: 01/25/2020
localization_priority: Priority
ms.openlocfilehash: f75b9c1ed61c100de9fe53c17d7b8373d57b377d
ms.sourcegitcommit: fa4e81fcf41b1c39d5516edf078f3ffdbd4a3997
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/17/2020
ms.locfileid: "42719173"
---
# <a name="authenticate-and-authorize-with-the-office-dialog-api"></a><span data-ttu-id="8af03-103">使用 Office 对话框 API 进行身份验证和授权</span><span class="sxs-lookup"><span data-stu-id="8af03-103">Authenticate and authorize with the Office dialog API</span></span>

<span data-ttu-id="8af03-104">许多身份验证机构（也称为安全令牌服务 (STS)）会阻止其登录页面在 iframe 中打开。</span><span class="sxs-lookup"><span data-stu-id="8af03-104">Many identity authorities, also called Secure Token Services (STS), prevent their login page from opening in an iframe.</span></span> <span data-ttu-id="8af03-105">这包括 Google、Facebook 以及由 Microsoft 身份平台（以前称为 Azure AD V 2.0）保护的服务，例如 Microsoft 帐户和 Office 365（工作或学校帐户）。</span><span class="sxs-lookup"><span data-stu-id="8af03-105">These include Google, Facebook, and services protected by Microsoft Identity Platform (formerly Azure AD V 2.0) such as Microsoft Account and Office 365 (Work or School accounts).</span></span> <span data-ttu-id="8af03-106">这会导致 Office 加载项出现问题，因为当此加载项在 **Office 网页版**上运行时，任务窗格是一个 iframe。</span><span class="sxs-lookup"><span data-stu-id="8af03-106">This creates a problem for Office Add-ins because when the add-in is running in **Office on the web**, the task pane is an iframe.</span></span> <span data-ttu-id="8af03-107">如果加载项可以打开完全独立的浏览器实例,则加载项的用户只能登录到其中一个服务。</span><span class="sxs-lookup"><span data-stu-id="8af03-107">Users of an add-in can only login to one of these services if the add-in can open an entirely separate browser instance.</span></span> <span data-ttu-id="8af03-108">这就是为什么 Office 提供 [Office 对话框 API](dialog-api-in-office-add-ins.md)（尤其是[displayDialogAsync](/javascript/api/office/office.ui) 方法）的原因。</span><span class="sxs-lookup"><span data-stu-id="8af03-108">This is why Office provides its [Office dialog API](dialog-api-in-office-add-ins.md), specifically the [displayDialogAsync](/javascript/api/office/office.ui) method.</span></span>

> [!NOTE]
> <span data-ttu-id="8af03-109">本文假设你熟悉[在 Office 加载项中使用 Office 对话框 API](dialog-api-in-office-add-ins.md)。</span><span class="sxs-lookup"><span data-stu-id="8af03-109">This article assumes that you are familiar with [Use the Office dialog API in your Office Add-ins](dialog-api-in-office-add-ins.md).</span></span>

<span data-ttu-id="8af03-110">使用此 API 打开的对话框具有以下特征:</span><span class="sxs-lookup"><span data-stu-id="8af03-110">The dialog box that is opened with this API has the following characteristics:</span></span>

- <span data-ttu-id="8af03-111">它是[非模态](https://en.wikipedia.org/wiki/Dialog_box)。</span><span class="sxs-lookup"><span data-stu-id="8af03-111">It is [nonmodal](https://en.wikipedia.org/wiki/Dialog_box).</span></span>
- <span data-ttu-id="8af03-112">它是完全独立于任务窗格的浏览器实例，这意味着：</span><span class="sxs-lookup"><span data-stu-id="8af03-112">It is a completely separate browser instance from the task pane, meaning:</span></span>
  - <span data-ttu-id="8af03-113">它拥有自己的 JavaScript 运行时环境和窗口对象及全局变量。</span><span class="sxs-lookup"><span data-stu-id="8af03-113">It has its own JavaScript runtime environment and window object and global variables.</span></span>
  - <span data-ttu-id="8af03-114">没有与任务窗格共享的执行环境。</span><span class="sxs-lookup"><span data-stu-id="8af03-114">There is no shared execution environment with the task pane.</span></span>
  - <span data-ttu-id="8af03-115">它不与任务窗格共享同一会话存储。</span><span class="sxs-lookup"><span data-stu-id="8af03-115">It does not share the same session storage as the task pane.</span></span>
- <span data-ttu-id="8af03-116">对话框中打开的第一个页面必须与任务窗格位于同一域中，包括协议、子域和端口（如果有）。</span><span class="sxs-lookup"><span data-stu-id="8af03-116">The first page opened in the dialog box must be hosted in the same domain as the task pane, including protocol, subdomains, and port, if any.</span></span>
- <span data-ttu-id="8af03-117">该对话框可通过使用 [messageParent](/javascript/api/office/office.ui#messageparent-message-) 方法将信息发送回任务窗格，但此方法只能从与任务窗格位于同一域（包括协议、子域和端口）的页面中调用。</span><span class="sxs-lookup"><span data-stu-id="8af03-117">The dialog box can send information back to the task pane by using the [messageParent](/javascript/api/office/office.ui#messageparent-message-) method, but this method can be called only from a page that is hosted in the same domain as the task pane, including protocol, subdomains, and port.</span></span>

<span data-ttu-id="8af03-118">如果该对话框不是 iframe（默认值）, 则它可以打开身份提供程序的登录页面。</span><span class="sxs-lookup"><span data-stu-id="8af03-118">When the dialog box is not an iframe (which is the default), it can open the login page of an identity provider.</span></span> <span data-ttu-id="8af03-119">如下所示，该 Office 对话框的特征对你如何使用身份验证或授权库（例如 MSAL 和护照）有一定影响。</span><span class="sxs-lookup"><span data-stu-id="8af03-119">As you'll see below, the characteristics of the Office dialog box have implications for how you use authentication or authorization libraries such as MSAL and Passport.</span></span>

> [!NOTE]
> <span data-ttu-id="8af03-120">可通过以下方式配置要在浮动 iframe 中打开的对话框：只需在对 `displayDialogAsync` 的调用中传递 `displayInIframe: true` 选项。</span><span class="sxs-lookup"><span data-stu-id="8af03-120">There is a way to configure the dialog box to open in a floating iframe: you simply pass the `displayInIframe: true` option in the call to `displayDialogAsync`.</span></span> <span data-ttu-id="8af03-121">使用对话框 API 登录时, 请*不要*这样做。</span><span class="sxs-lookup"><span data-stu-id="8af03-121">Do *not* do this when you are using the Office dialog API for login.</span></span>

## <a name="authentication-flow-with-the-office-dialog-box"></a><span data-ttu-id="8af03-122">使用 Office 对话框的身份验证流程</span><span class="sxs-lookup"><span data-stu-id="8af03-122">Authentication flow with the Office dialog box</span></span>

<span data-ttu-id="8af03-123">下面是一个简单的典型身份验证流程。</span><span class="sxs-lookup"><span data-stu-id="8af03-123">The following is a simple and typical authentication flow.</span></span> <span data-ttu-id="8af03-124">图示后提供了详细信息。</span><span class="sxs-lookup"><span data-stu-id="8af03-124">Details are after the diagram.</span></span>

![显示任务窗格与对话框浏览器进程的关系的图像。](../images/taskpane-dialog-processes.gif)

1. <span data-ttu-id="8af03-126">对话框中打开的第一个页面托管在加载项域（即与任务窗格相同的域）中的一个页面（或其他资源）。</span><span class="sxs-lookup"><span data-stu-id="8af03-126">The first page that opens in the dialog box is a page (or other resource) that is hosted in the add-in's domain; that is, the same domain as the task pane window.</span></span> <span data-ttu-id="8af03-127">此页面可以显示简单的 UI，提示用户“请稍候，正在重定向到可以登录 *NAME-OF-PROVIDER* 的页面。”</span><span class="sxs-lookup"><span data-stu-id="8af03-127">This page can have a simple UI that says "Please wait, we are redirecting you to the page where you can sign in to *NAME-OF-PROVIDER*."</span></span> <span data-ttu-id="8af03-128">此页面中的代码使用传递给对话框的信息（如[向对话框传递信息](dialog-api-in-office-add-ins.md#pass-information-to-the-dialog-box)中所述）构造身份提供程序的登录页 URL，或者硬编码到加载项的配置文件中，例如 web.config 文件。</span><span class="sxs-lookup"><span data-stu-id="8af03-128">The code in this page constructs the URL of the identity provider's sign-in page with information that is either passed to the dialog box as described in [Pass information to the dialog box](dialog-api-in-office-add-ins.md#pass-information-to-the-dialog-box) or is hardcoded into a configuration file of the add-in, such as a web.config file.</span></span>
2. <span data-ttu-id="8af03-129">然后，对话框窗口重定向到登录页。</span><span class="sxs-lookup"><span data-stu-id="8af03-129">The dialog box window then redirects to the sign-in page.</span></span> <span data-ttu-id="8af03-130">URL 包含一个查询参数，用于告知身份提供程序在用户登录后将对话框窗口重定向到特定页面。</span><span class="sxs-lookup"><span data-stu-id="8af03-130">The URL includes a query parameter that tells the identity provider to redirect the dialog box window to a specific page after the user signs in.</span></span> <span data-ttu-id="8af03-131">在本文中，我们将此页面称为 **redirectPage.html**。</span><span class="sxs-lookup"><span data-stu-id="8af03-131">In this article, we'll call this page **redirectPage.html**.</span></span> <span data-ttu-id="8af03-132">*这必须是主机窗口所在域中的页面*，以便可通过调用 `messageParent` 将登录尝试的结果传递到任务窗格。</span><span class="sxs-lookup"><span data-stu-id="8af03-132">*This must be a page in the same domain as the host window*, so that the results of the sign-in attempt can be passed to the task pane with a call of `messageParent`.</span></span>
3. <span data-ttu-id="8af03-133">身份提供程序的服务处理来自对话框窗口的传入 GET 请求。</span><span class="sxs-lookup"><span data-stu-id="8af03-133">The identity provider's service processes the incoming GET request from the dialog box window.</span></span> <span data-ttu-id="8af03-134">如果用户已经登录，它会立即将窗口重定向到 **redirectPage.html**，并包括用户数据作为查询参数。</span><span class="sxs-lookup"><span data-stu-id="8af03-134">If the user is already signed in, it immediately redirects the window to **redirectPage.html** and includes user data as a query parameter.</span></span> <span data-ttu-id="8af03-135">如果用户尚未登录，提供程序的登录页会显示在窗口中，以便用户登录。</span><span class="sxs-lookup"><span data-stu-id="8af03-135">If the user is not already signed in, the provider's sign-in page appears in the window, and the user signs in.</span></span> <span data-ttu-id="8af03-136">对于大多数提供程序，如果用户无法成功登录，提供程序会在对话框窗口中显示错误页面，而不会重定向到 **redirectPage.html**。</span><span class="sxs-lookup"><span data-stu-id="8af03-136">For most providers, if the user cannot sign in successfully, the provider shows an error page in the dialog box window and does not redirect to **redirectPage.html**.</span></span> <span data-ttu-id="8af03-137">用户必须通过选择右上角的 **X** 来关闭窗口。</span><span class="sxs-lookup"><span data-stu-id="8af03-137">The user must close the window by selecting the **X** in the corner.</span></span> <span data-ttu-id="8af03-138">如果用户成功登录，则对话框窗口会重定向到 **redirectPage.html**，并包括用户数据会作为查询参数。</span><span class="sxs-lookup"><span data-stu-id="8af03-138">If the user successfully signs in, the dialog box window is redirected to **redirectPage.html** and user data is included as a query parameter.</span></span>
4. <span data-ttu-id="8af03-139">当 **redirectPage.html** 页面打开时，它会调用 `messageParent` 向任务窗格页报告登录是否成功，而且还会视情况报告用户数据或错误数据。</span><span class="sxs-lookup"><span data-stu-id="8af03-139">When the **redirectPage.html** page opens, it calls `messageParent` to report the success or failure to the task pane page and optionally also report user data or error data.</span></span> <span data-ttu-id="8af03-140">其他可能的消息包括传递访问令牌或告知任务窗格信息位于存储中。</span><span class="sxs-lookup"><span data-stu-id="8af03-140">Other possible messages include passing an access token or telling the task pane that the token is in storage.</span></span>
5. <span data-ttu-id="8af03-141">`DialogMessageReceived` 事件在任务窗格页中触发，其处理程序关闭对话框窗口，并可能对消息进行进一步处理。</span><span class="sxs-lookup"><span data-stu-id="8af03-141">The `DialogMessageReceived` event fires in the task pane page and its handler closes the dialog box window and may further process of the message.</span></span>

#### <a name="support-multiple-identity-providers"></a><span data-ttu-id="8af03-142">支持多个标识提供程序</span><span class="sxs-lookup"><span data-stu-id="8af03-142">Support multiple identity providers</span></span>

<span data-ttu-id="8af03-p109">如果外接程序允许用户选择提供程序（如 Microsoft 帐户、Google 或 Facebook），你需要使用本地第一个页面（见前一部分），为用户提供用于选择提供程序的 UI。用户的选择会触发登录 URL 的构建并重定向到该 URL。</span><span class="sxs-lookup"><span data-stu-id="8af03-p109">If your add-in gives the user a choice of providers, such as Microsoft Account, Google, or Facebook, you need a local first page (see preceding section) that provides a UI for the user to select a provider. Selection triggers the construction of the sign-in URL and redirection to it.</span></span>

#### <a name="authorization-of-the-add-in-to-an-external-resource"></a><span data-ttu-id="8af03-145">在外接程序中授权外部资源</span><span class="sxs-lookup"><span data-stu-id="8af03-145">Authorization of the add-in to an external resource</span></span>

<span data-ttu-id="8af03-146">在现代网络中，用户和 Web 应用程序是安全主体。</span><span class="sxs-lookup"><span data-stu-id="8af03-146">In the modern web, users and web applications are security principals.</span></span> <span data-ttu-id="8af03-147">应用程序拥有自己的身份以及对联机资源（如 Office 365、Google Plus、Facebook 或 LinkedIn）的权限。</span><span class="sxs-lookup"><span data-stu-id="8af03-147">The application has its own identity and permissions to an online resource such as Office 365, Google Plus, Facebook, or LinkedIn.</span></span> <span data-ttu-id="8af03-148">在部署前，需要先向资源提供程序注册应用程序。</span><span class="sxs-lookup"><span data-stu-id="8af03-148">The application is registered with the resource provider before it is deployed.</span></span> <span data-ttu-id="8af03-149">注册内容包括：</span><span class="sxs-lookup"><span data-stu-id="8af03-149">The registration includes:</span></span>

- <span data-ttu-id="8af03-150">应用程序访所需的权限的列表。</span><span class="sxs-lookup"><span data-stu-id="8af03-150">A list of the permissions that the application needs.</span></span>
- <span data-ttu-id="8af03-151">当应用访问服务时，资源服务应向其返回访问令牌的 URL。</span><span class="sxs-lookup"><span data-stu-id="8af03-151">A URL to which the resource service should return an access token when the application accesses the service.</span></span>  

<span data-ttu-id="8af03-p111">如果用户在应用中调用访问资源服务中用户数据的函数，系统会先提示用户登录相应服务，再提示用户向应用授予访问用户资源所需的权限。然后，服务将登录窗口重定向到先前注册的 URL，并传递访问令牌。应用使用访问令牌访问用户资源。</span><span class="sxs-lookup"><span data-stu-id="8af03-p111">When a user invokes a function in the application that accesses the user's data in the resource service, they are prompted to sign in to the service and then prompted to grant the application the permissions it needs to the user's resources. The service then redirects the sign-in window to the previously registered URL and passes the access token. The application uses the access token to access the user's resources.</span></span>

<span data-ttu-id="8af03-155">可以使用 Office 对话框 API 来管理此过程，具体方法是使用与用户登录流程类似的流程。</span><span class="sxs-lookup"><span data-stu-id="8af03-155">You can use the Office dialog API to manage this process by using a flow that is similar to the one described for users to sign in.</span></span> <span data-ttu-id="8af03-156">唯一区别在于：</span><span class="sxs-lookup"><span data-stu-id="8af03-156">The only differences are:</span></span>

- <span data-ttu-id="8af03-157">如果用户先前未向应用程序授予所需的权限，则登录后会在对话框中看到这样做的提示。</span><span class="sxs-lookup"><span data-stu-id="8af03-157">If the user hasn't previously granted the application the permissions it needs, the user is prompted to do so in the dialog box after signing in.</span></span>
- <span data-ttu-id="8af03-158">对话框窗口使用 `messageParent` 发送字符串化访问令牌，或将访问令牌存储在主机窗口可以检索到的位置（并使用 `messageParent` 告知主机窗口令牌可用），从而将访问令牌发送到主机窗口。</span><span class="sxs-lookup"><span data-stu-id="8af03-158">The dialog box window sends the access token to the host window either by using `messageParent` to send the stringified access token or by storing the access token where the host window can retrieve it (and using `messageParent` to tell the host window that the token is available).</span></span> <span data-ttu-id="8af03-159">令牌具有时间限制，但在持续期间，主机窗口可以使用它直接访问用户资源，而无需进一步提示。</span><span class="sxs-lookup"><span data-stu-id="8af03-159">The token has a time limit, but while it lasts, the host window can use it to directly access the user's resources without any further prompting.</span></span>

<span data-ttu-id="8af03-160">[示例](#samples)中列出了使用 Office 对话框 API 来实现此目的的一些身份验证示例加载项。</span><span class="sxs-lookup"><span data-stu-id="8af03-160">Some authentication sample add-ins that use the Office dialog API for this purpose are listed in [Samples](#samples).</span></span>

## <a name="using-authentication-libraries-with-the-dialog-box"></a><span data-ttu-id="8af03-161">将身份验证库与对话框结合使用</span><span class="sxs-lookup"><span data-stu-id="8af03-161">Using authentication libraries with the dialog box</span></span>

<span data-ttu-id="8af03-162">Office 对话框和任务窗格在不同的浏览器、JavaScript 运行时实例中运行意味着你必须使用多个身份验证/授权库，其使用方式必须与在同一窗口中进行身份验证和授权时使用它们的方式不同。</span><span class="sxs-lookup"><span data-stu-id="8af03-162">The fact that the Office dialog box and the task pane run in different browser, and JavaScript runtime, instances means that you must use many authentication/authorization libraries in the way that is different from how they are used when authentication and authorization can take place in the same window.</span></span> <span data-ttu-id="8af03-163">以下部分介绍了通常无法使用这些库的主要方式，以及*可以*使用这些库的方式。</span><span class="sxs-lookup"><span data-stu-id="8af03-163">The following sections describe the main ways that you usually cannot use these libraries and the way that you *can* use them.</span></span>

### <a name="you-usually-cannot-use-the-librarys-internal-cache-to-store-tokens"></a><span data-ttu-id="8af03-164">通常无法使用库的内部缓存来存储令牌</span><span class="sxs-lookup"><span data-stu-id="8af03-164">You usually cannot use the library's internal cache to store tokens</span></span>

<span data-ttu-id="8af03-165">通常，身份验证相关库提供内存缓存来存储访问令牌。</span><span class="sxs-lookup"><span data-stu-id="8af03-165">Typically, auth-related libraries provide an in-memory cache to store the access token.</span></span> <span data-ttu-id="8af03-166">如果对资源提供程序（例如 Google、Microsoft Graph、Facebook 等）进行了后续调用，则库将首先检查以确定其缓存中的令牌是否已过期。</span><span class="sxs-lookup"><span data-stu-id="8af03-166">If subsequent calls to the resource provider (such as Google, Microsoft Graph, Facebook, etc.) are made, the library will first check to see if the token in its cache is expired.</span></span> <span data-ttu-id="8af03-167">如果未过期，库将返回缓存的令牌，而不是为新令牌再执行一次到 STS 的往返行程。</span><span class="sxs-lookup"><span data-stu-id="8af03-167">If it is unexpired, the library returns the cached token rather than making another round-trip to the STS for a new token.</span></span> <span data-ttu-id="8af03-168">但 Office 加载项中无法使用此模式。由于登录发生在 Office 对话框的浏览器实例中，因此令牌缓存处于该实例中。</span><span class="sxs-lookup"><span data-stu-id="8af03-168">But this pattern is not usable in Office add-ins. Since the login occurs in the Office dialog box's browser instance, the token cache is in that instance.</span></span>

<span data-ttu-id="8af03-169">与此非常密切相关的是，库通常会同时提供用于获取令牌的交互式和“无提示”方法。</span><span class="sxs-lookup"><span data-stu-id="8af03-169">Closely related to this is the fact that a library will typically provide both interactive and "silent" methods for getting a token.</span></span> <span data-ttu-id="8af03-170">如果你既可以进行身份验证，也可以在同一浏览器实例中对资源进行数据调用，则代码会调用无提示方法来获取令牌，然后马上将该令牌添加到数据调用。</span><span class="sxs-lookup"><span data-stu-id="8af03-170">When you can do both the authentication and the data calls to the resource in the same browser instance, your code calls the silent method to obtain a token just before your code adds the token to the data call.</span></span> <span data-ttu-id="8af03-171">无提示方法会检查缓存是否有中未过期的令牌，并将其返回（如果有）。</span><span class="sxs-lookup"><span data-stu-id="8af03-171">The silent method checks for an unexpired token in the cache and returns it, if there is one.</span></span> <span data-ttu-id="8af03-172">否则，无提示方法将调用重定向到 STS 登录的交互式方法。</span><span class="sxs-lookup"><span data-stu-id="8af03-172">Otherwise, the silent method calls the interactive method which redirects to the STS's login.</span></span> <span data-ttu-id="8af03-173">登录完成后，交互式方法将返回令牌，但同时会将其缓存在内存中。</span><span class="sxs-lookup"><span data-stu-id="8af03-173">After login completes, the interactive method returns the token, but also caches it in memory.</span></span> <span data-ttu-id="8af03-174">但是，在使用 Office 对话框 API 时，对资源的数据调用（它将调用无提示方法）位于任务窗格的浏览器实例中。</span><span class="sxs-lookup"><span data-stu-id="8af03-174">But when the Office dialog API is being used, the data calls to the resource, which would call the silent method, are in the task pane's browser instance.</span></span> <span data-ttu-id="8af03-175">库的令牌缓存在该实例中不存在。</span><span class="sxs-lookup"><span data-stu-id="8af03-175">The library's token cache does not exist in that instance.</span></span>

<span data-ttu-id="8af03-176">或者，加载项的对话框浏览器实例可以直接调用库的交互式方法。</span><span class="sxs-lookup"><span data-stu-id="8af03-176">As an alternative, your add-in's dialog box browser instance can directly call the library's interactive method.</span></span> <span data-ttu-id="8af03-177">该方法返回令牌时，代码必须将令牌显式存储在任务窗格的浏览器可检索到的位置，例如本地存储\*或服务器端数据库。</span><span class="sxs-lookup"><span data-stu-id="8af03-177">When that method returns a token, your code must explicitly store the token someplace where the task pane's browser instance can retrieve it, such as Local Storage\* or a server-side database.</span></span> <span data-ttu-id="8af03-178">另一种选择是使用 `messageParent` 方法将令牌传递到任务窗格。</span><span class="sxs-lookup"><span data-stu-id="8af03-178">Another option is to pass the token to the task pane with the `messageParent` method.</span></span> <span data-ttu-id="8af03-179">仅当交互式方法将访问令牌存储在代码可以读取的位置时，才可以使用此替代选项。</span><span class="sxs-lookup"><span data-stu-id="8af03-179">This alternative is only possible if the interactive method stores the access token in a place where your code can read it.</span></span> <span data-ttu-id="8af03-180">有时，库的交互式方法设计为将令牌存储到代码无法访问的对象的私有属性中。</span><span class="sxs-lookup"><span data-stu-id="8af03-180">Sometimes a library's interactive method is designed to store the token in a private property of an object that is inaccessible to your code.</span></span>

> [!NOTE]
> <span data-ttu-id="8af03-181">\*有一个 bug 将影响你的令牌处理策略。</span><span class="sxs-lookup"><span data-stu-id="8af03-181">\* There is a bug that will effect your strategy for token handling.</span></span> <span data-ttu-id="8af03-182">如果加载项正使用 Safari 或 Microsoft 浏览器在 **Office 网页版**上运行，则对话框和任务窗格不共享同一本地存储，因此该存储无法用于在它们之间通信。</span><span class="sxs-lookup"><span data-stu-id="8af03-182">If the add-in is running in **Office on the web** in either the Safari or Edge browser, the dialog box and task pane do not share the same Local Storage, so it cannot be used to communicate between them.</span></span>

### <a name="you-usually-cannot-use-the-librarys-auth-context-object"></a><span data-ttu-id="8af03-183">通常无法使用库的“身份验证上下文”对象</span><span class="sxs-lookup"><span data-stu-id="8af03-183">You usually cannot use the library's "auth context" object</span></span>

<span data-ttu-id="8af03-184">通常情况下，与身份验证相关的库有一种方法，该方法既能够以交互方式获取令牌，也会创建方法返回的“身份验证上下文”对象。</span><span class="sxs-lookup"><span data-stu-id="8af03-184">Often, an auth-related library has a method that both obtains a token interactively and also creates an "auth-context" object which the method returns.</span></span> <span data-ttu-id="8af03-185">令牌是对象的一个属性（可能是私有属性，并且无法直接从代码中访问）。</span><span class="sxs-lookup"><span data-stu-id="8af03-185">The token is a property of the object (possibly private and inaccessible directly from your code).</span></span> <span data-ttu-id="8af03-186">该对象具有从资源中获取数据的方法。</span><span class="sxs-lookup"><span data-stu-id="8af03-186">That object has the methods that get data from the resource.</span></span> <span data-ttu-id="8af03-187">这些方法将令牌包括在其对资源提供程序（例如 Google、Microsoft Graph、Facebook 等）进行的 HTTP 请求中。</span><span class="sxs-lookup"><span data-stu-id="8af03-187">These methods include the token in the HTTP Requests that they make to the resource provider (such as Google, Microsoft Graph, Facebook, etc.).</span></span>

<span data-ttu-id="8af03-188">这些身份验证上下文对象和创建它们的方法在 Office 加载项中不可用。由于登录发生在 Office 对话框的浏览器实例中，因此必须在该处创建对象。</span><span class="sxs-lookup"><span data-stu-id="8af03-188">These auth-context objects, and the methods that create them, are not usable in Office add-ins. Since the login occurs in the Office dialog box's browser instance, the object would have to be created there.</span></span> <span data-ttu-id="8af03-189">但对资源的数据调用位于任务窗格浏览器实例中，因此无法将对象从一个实例获取到另一个实例。</span><span class="sxs-lookup"><span data-stu-id="8af03-189">But the data calls to the resource are in the task pane browser instance and there is no way to get the object from one instance to another.</span></span> <span data-ttu-id="8af03-190">例如，你无法通过 `messageParent` 传递对象，因为 `messageParent` 只能传递字符串或布尔值。</span><span class="sxs-lookup"><span data-stu-id="8af03-190">For example, you cannot pass the object with `messageParent` because `messageParent` can only pass strings or boolean values.</span></span> <span data-ttu-id="8af03-191">无法可靠地将包含方法的 JavaScript 对象字符串化。</span><span class="sxs-lookup"><span data-stu-id="8af03-191">A JavaScript object with methods cannot be reliably stringified.</span></span>

### <a name="how-you-can-use-libraries-with-the-office-dialog-api"></a><span data-ttu-id="8af03-192">如何将库与 Office 对话框 API 结合使用</span><span class="sxs-lookup"><span data-stu-id="8af03-192">How you can use libraries with the Office dialog API</span></span>

<span data-ttu-id="8af03-193">大多数库提供了更低抽象级别的 API 作为单一“身份验证相关”对象的补充（或取代这些对象），可让代码创建不太单一的整体帮助程序对象。</span><span class="sxs-lookup"><span data-stu-id="8af03-193">In addition to, or instead of, monolithic "auth context" objects, most libraries provide APIs at a lower level of abstraction that enable your code to create less monolithic helper objects.</span></span> <span data-ttu-id="8af03-194">例如，[MSAL.NET](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki#conceptual-documentation) v.</span><span class="sxs-lookup"><span data-stu-id="8af03-194">For example, [MSAL.NET](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki#conceptual-documentation) v.</span></span> <span data-ttu-id="8af03-195">3. x.x 有一个用于构造登录 URL 的 API，以及另一个用于构造 AuthResult 对象的 API，该对象在代码可访问的属性中包含访问令牌。</span><span class="sxs-lookup"><span data-stu-id="8af03-195">3.x.x has an API to construct a login URL, and another API that constructs an AuthResult object that contains an access token in a property that is accessible to your code.</span></span> <span data-ttu-id="8af03-196">有关 Office 加载项中的 MSAL.NET 的示例，请参阅: [Office 加载项 Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-ASPNET) 和 [Outlook 加载项 Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Outlook-Add-in-Microsoft-Graph-ASPNET)。</span><span class="sxs-lookup"><span data-stu-id="8af03-196">For examples of MSAL.NET in an Office add-in see: [Office Add-in Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-ASPNET) and [Outlook Add-in Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Outlook-Add-in-Microsoft-Graph-ASPNET).</span></span> <span data-ttu-id="8af03-197">有关在加载项中使用 [msal.js](https://github.com/AzureAD/microsoft-authentication-library-for-js) 的示例，请参阅 [Office 加载项 Microsoft Graph React](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-React)。</span><span class="sxs-lookup"><span data-stu-id="8af03-197">For an example of using [msal.js](https://github.com/AzureAD/microsoft-authentication-library-for-js) in an add-in, see [Office Add-in Microsoft Graph React](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-React).</span></span>

<span data-ttu-id="8af03-198">有关身份验证和授权库的详细信息，请参阅 [Microsoft Graph：推荐的库](authorize-to-microsoft-graph-without-sso.md#recommended-libraries-and-samples)和[其他外部服务：库](auth-external-add-ins.md#libraries)。</span><span class="sxs-lookup"><span data-stu-id="8af03-198">For more information about authentication and authorization libraries, see [Microsoft Graph: Recommended libraries](authorize-to-microsoft-graph-without-sso.md#recommended-libraries-and-samples) and [Other external services: Libraries](auth-external-add-ins.md#libraries).</span></span>

## <a name="samples"></a><span data-ttu-id="8af03-199">示例</span><span class="sxs-lookup"><span data-stu-id="8af03-199">Samples</span></span>

- <span data-ttu-id="8af03-200">[Office 加载项 Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-ASPNET)：一个基于 ASP.NET 的加载项（Excel、Word 或 PowerPoint），它使用 MSAL.NET 库和授权代码流进行登录并获取 Microsoft Graph 数据的访问令牌。</span><span class="sxs-lookup"><span data-stu-id="8af03-200">[Office Add-in Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-ASPNET): An ASP.NET based add-in (Excel, Word, or PowerPoint) that uses the MSAL.NET library and the Authorization Code Flow to log in and get an access token for Microsoft Graph data.</span></span>
- <span data-ttu-id="8af03-201">[Outlook 加载项 Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Outlook-Add-in-Microsoft-Graph-ASPNET)：与上面的加载项一样，但 Office 应用程序为 Outlook。</span><span class="sxs-lookup"><span data-stu-id="8af03-201">[Outlook Add-in Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Outlook-Add-in-Microsoft-Graph-ASPNET): Just like the one above, but the Office application is Outlook.</span></span>
- <span data-ttu-id="8af03-202">[Office 加载项 Microsoft Graph React](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-React)：一个基于 NodeJS 的加载项（Excel、Word 或 PowerPoint），它使用 msal.js 库和隐式流进行登录并获取 Microsoft Graph 数据的访问令牌。</span><span class="sxs-lookup"><span data-stu-id="8af03-202">[Office Add-in Microsoft Graph React](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-React): A NodeJS based add-in (Excel, Word, or PowerPoint) that uses the msal.js library and the Implicit Flow to log in and get an access token for Microsoft Graph data.</span></span>


<span data-ttu-id="8af03-203">有关详细信息，请参阅：</span><span class="sxs-lookup"><span data-stu-id="8af03-203">For more information, see:</span></span>
- [<span data-ttu-id="8af03-204">在 Office 加载项中授权外部服务</span><span class="sxs-lookup"><span data-stu-id="8af03-204">Authorize external services in your Office Add-in</span></span>](auth-external-add-ins.md)
- [<span data-ttu-id="8af03-205">在 Office 加载项中使用对话框 API</span><span class="sxs-lookup"><span data-stu-id="8af03-205">Use the Office dialog API in your Office Add-ins</span></span>](dialog-api-in-office-add-ins.md)
