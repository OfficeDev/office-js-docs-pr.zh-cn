---
title: 向 Office 加载项中的 Microsoft Graph 授权
description: ''
ms.date: 04/10/2018
ms.openlocfilehash: d22b2d0e9b40098e2e918183b1eb18011e7bca25
ms.sourcegitcommit: 4de2a1b62ccaa8e51982e95537fc9f52c0c5e687
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/10/2018
ms.locfileid: "22925127"
---
# <a name="authorize-to-microsoft-graph-in-your-office-add-in-preview"></a><span data-ttu-id="e9bbe-102">向 Office 加载项（预览版）中的 Microsoft Graph 授权</span><span class="sxs-lookup"><span data-stu-id="e9bbe-102">Authorize to Microsoft Graph in your Office Add-in (preview)</span></span>

<span data-ttu-id="e9bbe-103">用户可以使用自己的个人 Microsoft 帐户/工作或学校 (Office 365) 帐户，登录 Office（在线、移动和桌面平台）。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-103">Users sign in to Office (online, mobile, and desktop platforms) using either their personal Microsoft account or their work or school (Office 365) account.</span></span> <span data-ttu-id="e9bbe-104">Office 加载项获得 [Microsoft Graph](https://developer.microsoft.com/graph/docs) 授权访问权限的最佳方式是使用用户的 Office 登录凭据。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-104">The best way for an Office add-in to get authorized access to [Microsoft Graph](https://developer.microsoft.com/graph/docs) is to use the credentials from the user's Office sign on.</span></span> <span data-ttu-id="e9bbe-105">如此一来，Office 加载项能够访问其 Microsoft Graph 数据，而无需再次登录。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-105">This enables them to access their Microsoft Graph data without needing to sign in a second time.</span></span> 

> [!NOTE]
> <span data-ttu-id="e9bbe-106">目前，Word、Excel、Outlook和 PowerPoint 预览版支持单一登录 API。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-106">The Single Sign-on API is currently supported in preview for Word, Excel, Outlook, and PowerPoint.</span></span> <span data-ttu-id="e9bbe-107">若要详细了解目前支持单一登录 API 的平台，请参阅 [IdentityAPI 要求集](https://dev.office.com/reference/add-ins/requirement-sets/identity-api-requirement-sets)。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-107">For more information about where the Single Sign-on API is currently supported, see [IdentityAPI requirement sets](https://dev.office.com/reference/add-ins/requirement-sets/identity-api-requirement-sets).</span></span>
> <span data-ttu-id="e9bbe-108">如果使用的是 Outlook 加载项，请务必为 Office 365 租赁启用新式验证。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-108">If you are working with an Outlook add-in, be sure to enable Modern Authentication for the Office 365 tenancy.</span></span> <span data-ttu-id="e9bbe-109">预知有关如何执行此操作详情，请参阅 [在线交流：如何为租户您启用新式验证](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx)。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-109">For information about how to do this, see [Exchange Online: How to enable your tenant for modern authentication](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span></span>

## <a name="add-in-architecture-for-sso-and-microsoft-graph"></a><span data-ttu-id="e9bbe-110">用于 SSO 和 Microsoft Graph 的加载项体系结构</span><span class="sxs-lookup"><span data-stu-id="e9bbe-110">Add-in architecture for SSO and Microsoft Graph</span></span>

<span data-ttu-id="e9bbe-111">除了托管 Web 应用程序的页面和 JavaScript 之外，外接程序还必须以相同的[完全限定的域名](https://msdn.microsoft.com/library/windows/desktop/ms682135.aspx#_dns_fully_qualified_domain_name_fqdn__gly)托管一个或多个 Web API，这些 API 可获取 Microsoft Graph 的访问令牌，并向它发出请求。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-111">In addition to hosting the pages and JavaScript of the web application, the add-in must also host, at the same [fully qualified domain name](https://msdn.microsoft.com/library/windows/desktop/ms682135.aspx#_dns_fully_qualified_domain_name_fqdn__gly), one or more web APIs that will get an access token to Microsoft Graph and make requests to it.</span></span>

<span data-ttu-id="e9bbe-112">外接程序清单包含标记，用于指定外接程序在 Azure Active Directory (Azure AD) v2.0 终结点中的注册方式，并指定外接程序需要的 Microsoft Graph 的任何权限。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-112">The add-in manifest contains markup that specifies how the add-in is registered in the Azure Active Directory (Azure AD) v2.0 endpoint, and it specifies any permissions to Microsoft Graph that the add-in needs.</span></span>

### <a name="how-it-works-at-runtime"></a><span data-ttu-id="e9bbe-113">在运行时的工作方式</span><span class="sxs-lookup"><span data-stu-id="e9bbe-113">How it works at runtime</span></span>

<span data-ttu-id="e9bbe-114">以下关系图显示了登录 Microsoft Graph 和获取访问的工作原理。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-114">The following diagram shows how the process of signing in and getting access to Microsoft Graph works.</span></span>

![显示SSO过程的图表](../images/sso-access-to-microsoft-graph.png)

1. <span data-ttu-id="e9bbe-116">在加载项中，JavaScript 调用新的 Office.js API `getAccessTokenAsync`。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-116">In the add-in, JavaScript calls a new Office.js API `getAccessTokenAsync`.</span></span> <span data-ttu-id="e9bbe-117">指示 Office 主机应用程序获取加载项的访问令牌。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-117">This tells the Office host application to obtain an access token to the add-in.</span></span> <span data-ttu-id="e9bbe-118">（此后，这被称为**引导程序访问令牌** ，因为它在进程后期被替换为第二个令牌。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-118">(Hereafter, this is called the **bootstrap access token** because it is replaced with a second token later in the process.</span></span> <span data-ttu-id="e9bbe-119">有关已解码的引导程序访问令牌示例，请参阅[示例访问令牌](sso-in-office-add-ins.md#example-access-token)。）</span><span class="sxs-lookup"><span data-stu-id="e9bbe-119">For an example of a decoded bootstrap access token, see [Example access token](sso-in-office-add-ins.md#example-access-token).)</span></span>
1. <span data-ttu-id="e9bbe-120">如果用户未登录，Office主机应用会打开弹出窗口，以供用户登录。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-120">If the user is not signed in, the Office host application opens a pop-up window for the user to sign in.</span></span>
1. <span data-ttu-id="e9bbe-121">如果当前用户是首次使用加载项，他或她则会看到同意提示。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-121">If this is the first time the current user has used your add-in, he or she is prompted to consent.</span></span>
1. <span data-ttu-id="e9bbe-122">Office主机应用程序从当前用户的Azure AD v2.0端点请求获取**引导程序访问令牌**。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-122">The Office host application requests the **add-in token** from the Azure AD v2.0 endpoint for the current user.</span></span>
1. <span data-ttu-id="e9bbe-123">Azure AD 将引导程序令牌发送给 Office 主机应用程序。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-123">Azure AD sends the add-in token to the Office host application.</span></span>
1. <span data-ttu-id="e9bbe-124">Office主机应用程序发送引导程序访问令牌到加载项通过调用作为返回的结果对象的一部分。** ** `getAccessTokenAsync`</span><span class="sxs-lookup"><span data-stu-id="e9bbe-124">The Office host application sends the **add-in token** to the add-in as part of the result object returned by the `getAccessTokenAsync` call.</span></span>
1. <span data-ttu-id="e9bbe-125">加载项中的 JavaScript 向 Web API（与加载项托管在同一完全限定的域中）发出 HTTP 请求，并添加 **引导程序访问令牌** 作为授权证明。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-125">JavaScript in the add-in makes an HTTP request to a web API that is hosted at the same fully-qualified domain as the add-in, and it includes the **add-in token** as authorization proof.</span></span>  
1. <span data-ttu-id="e9bbe-126">服务器端代码验证传入**引导程序访问令牌**。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-126">Server-side code validates the incoming **add-in token**.</span></span>
1. <span data-ttu-id="e9bbe-127">服务器端代码使用“代表”流程（在 [ OAuth2 令牌交换](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02)和 [ Web API Azure 方案的守护进程或服务器应用程序](https://docs.microsoft.com/azure/active-directory/develop/active-directory-authentication-scenarios#daemon-or-server-application-to-web-api)中定义）获取 Microsoft Graph 的访问令牌来交换引导程序访问令牌。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-127">Server-side code uses the “on behalf of” flow (defined at [OAuth2 Token Exchange](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02) and the [daemon or server application to web API Azure scenario](https://docs.microsoft.com/azure/active-directory/develop/active-directory-authentication-scenarios#daemon-or-server-application-to-web-api)) to obtain an access token for Microsoft Graph (hereafter, the "MSG token") in exchange for the add-in token.</span></span>
1. <span data-ttu-id="e9bbe-128">Azure AD将Microsoft Graph访问令牌 （如果外接程序请求获取 *offline_access*权限，则同时返回刷新令牌）返回给加载项。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-128">Azure AD returns the MSG token (and a refresh token, if the add-in requests offline_access permission) to the add-in.</span></span>
1. <span data-ttu-id="e9bbe-129">服务器端代码将相应访问令牌缓存到 Microsoft Graph。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-129">Server-side code caches the access token to Microsoft Graph.</span></span>
1. <span data-ttu-id="e9bbe-130">服务器端代码向 Microsoft Graph 发出请求，并将访问令牌包含到 Microsoft Graph 中。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-130">Server-side code makes requests to Microsoft Graph and includes the MSG token.</span></span>
1. <span data-ttu-id="e9bbe-131">Microsoft Graph将数据返回给加载项，从而将数据传递到加载项UI。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-131">Microsoft Graph returns data to the add-in, which can pass it on to the add-in’s UI.</span></span>
1. <span data-ttu-id="e9bbe-132">当 Microsoft Graph 的访问令牌到期时，服务器端代码可以使用其刷新令牌获取新的 Microsoft Graph 访问令牌。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-132">When the access token to Microsoft Graph expires, the server-side code can use its refresh token to get a new access token to Microsoft Graph.</span></span>

## <a name="develop-an-sso-add-in-that-accesses-microsoft-graph"></a><span data-ttu-id="e9bbe-133">开发用于访问 Microsoft Graph 的 SSO 加载项</span><span class="sxs-lookup"><span data-stu-id="e9bbe-133">Develop an SSO add-in that accesses Microsoft Graph</span></span>

<span data-ttu-id="e9bbe-134">正如开发任何其他使用 SSO 的加载项一样，可以开发一个访问 Microsoft Graph 的加载项。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-134">You develop an add-in that accesses Microsoft Graph just as you would any other add-in that uses SSO.</span></span> <span data-ttu-id="e9bbe-135">有关详细说明，请参阅[为 Office 加载项启用单一登录](https://docs.microsoft.com/office/dev/add-ins/develop/sso-in-office-add-ins)。不同之处在于，加载项必须具有服务器端 Web API，并且该文章中所谓的访问令牌称为“引导程序访问令牌”。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-135">For a thorough description, see [Enable single sign-on for Office Add-ins](https://docs.microsoft.com/office/dev/add-ins/develop/sso-in-office-add-ins). The difference is that it is mandatory that the add-in have a server-side Web API, and what's called the access token in that article is called the "bootstrap access token."</span></span> 

<span data-ttu-id="e9bbe-136">根据您的语言和框架，可能会提供库，这将简化您必须编写的服务器端代码。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-136">Depending on your language and framework, libraries might be available that will simplify the code you have to write.</span></span> <span data-ttu-id="e9bbe-137">您的代码应该执行以下操作：</span><span class="sxs-lookup"><span data-stu-id="e9bbe-137">Your server-side code should do the following:</span></span>

* <span data-ttu-id="e9bbe-138">验证从之前创建的令牌处理程序收到的加载项引导程序访问令牌。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-138">Validate the add-in token that is received from the token handler you created earlier.</span></span> <span data-ttu-id="e9bbe-139">有关更多信息，请参阅[验证访问令牌](sso-in-office-add-ins.md#validate-the-access-token)。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-139">For more information, see [Validate the access token](sso-in-office-add-ins.md#validate-the-access-token).</span></span> 
* <span data-ttu-id="e9bbe-140">通过调用Azure AD v2.0 端点启动“代表”流程，该端点包括引导程序访问令牌、关于用户的一些元数据以及外接程序的凭据（相应ID和密钥）。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-140">Initiate the “on behalf of” flow with a call to the Azure AD v2.0 endpoint that includes the add-in access token, some metadata about the user, and the credentials of the add-in (its ID and secret).</span></span>
* <span data-ttu-id="e9bbe-141">将返回的访问令牌缓存到 Microsoft Graph 。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-141">Use the access token to call Microsoft Graph.</span></span> <span data-ttu-id="e9bbe-142">有关此流程的更多信息，请参阅 [Azure Active Directory v2.0 和 OAuth 2.0 代表流程](https://docs.microsoft.com/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of)。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-142">For more information about this flow see [Azure Active Directory v2.0 and OAuth 2.0 On-Behalf-Of flow](https://docs.microsoft.com/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).</span></span>
* <span data-ttu-id="e9bbe-143">通过将缓存的访问令牌传递给 Microsoft Graph，创建一个或多个获取 Microsoft Graph 数据的 Web API 方法。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-143">Create one or more Web API methods that get Microsoft Graph data by passing the cached access token to Microsoft Graph.</span></span>

> [!NOTE]
> <span data-ttu-id="e9bbe-144">有关“代表”流程获取的已解码的 Microsoft Graph 访问令牌示例，请参阅 [Azure Active Directory v2.0 和 OAuth 2.0 代表流程](https://docs.microsoft.com/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of)。</span><span class="sxs-lookup"><span data-stu-id="e9bbe-144">For examples of decoded access tokens for Microsoft Graph that have been obtained by the "on-behalf-of" flow, see [Azure Active Directory v2.0 and OAuth 2.0 On-Behalf-Of flow](https://docs.microsoft.com/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).</span></span>

<span data-ttu-id="e9bbe-145">有关详细 演练和应用场景的示例，请参阅：</span><span class="sxs-lookup"><span data-stu-id="e9bbe-145">For examples of detailed walkthroughs, see:</span></span>

* [<span data-ttu-id="e9bbe-146">创建使用单一登录的 Node.js Office 加载项</span><span class="sxs-lookup"><span data-stu-id="e9bbe-146">Create a Node.js Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-nodejs.md)
* [<span data-ttu-id="e9bbe-147">创建使用单一登录的ASP.NET Office加载项</span><span class="sxs-lookup"><span data-stu-id="e9bbe-147">Create an ASP.NET Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-aspnet.md)
* [<span data-ttu-id="e9bbe-148">脚本：为 Outlook 加载项中的服务实现单一登录</span><span class="sxs-lookup"><span data-stu-id="e9bbe-148">Scenario: Implement single sign-on to your service in an Outlook Add-in</span></span>](https://docs.microsoft.com/outlook/add-ins/implement-sso-in-outlook-add-in)



