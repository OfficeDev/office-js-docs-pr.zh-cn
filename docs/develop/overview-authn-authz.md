---
title: Office 加载项中的身份验证和授权概述
description: 要求用户在 Web 应用程序和 Office 加载项中对登录进行身份验证。
ms.date: 07/30/2020
localization_priority: Priority
ms.openlocfilehash: ba3d0aa11f8fa6537f444c063809c89c79ea7b2b
ms.sourcegitcommit: 8fdd7369bfd97a273e222a0404e337ba2b8807b0
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/05/2020
ms.locfileid: "46573145"
---
# <a name="overview-of-authentication-and-authorization-in-office-add-ins"></a><span data-ttu-id="885b8-103">Office 加载项中的身份验证和授权概述</span><span class="sxs-lookup"><span data-stu-id="885b8-103">Overview of authentication and authorization in Office Add-ins</span></span>

<span data-ttu-id="885b8-104">Web 应用程序和 Office 加载项默认允许匿名访问，但你可要求用户通过登录进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="885b8-104">Web applications and, hence, Office Add-ins allow anonymous access by default, but you can require users to authenticate with a login.</span></span> <span data-ttu-id="885b8-105">例如，你可以要求用户使用 Microsoft 帐户、Microsoft 365 教育版或工作帐户，或者其他常用帐户登录。</span><span class="sxs-lookup"><span data-stu-id="885b8-105">For example, you can require that your users be logged in with a Microsoft account, a Microsoft 365 Education or work account, or other common account.</span></span> <span data-ttu-id="885b8-106">此任务被称为“用户身份验证”，因为它让加载项能够知道用户的身份。</span><span class="sxs-lookup"><span data-stu-id="885b8-106">This task is called user authentication because it enables the add-in to know who the user is.</span></span>

<span data-ttu-id="885b8-107">你的加载项还能从用户处获得对其以下数据的访问许可：Microsoft Graph 数据（例如其 Microsoft 365 个人资料、OneDrive 文件和 SharePoint 数据），或者 Google、Facebook、领英、SalesForce 和 GitHub 等其他外部源中的数据。</span><span class="sxs-lookup"><span data-stu-id="885b8-107">Your add-in can also get the user's consent to access their Microsoft Graph data (such as their Microsoft 365 profile, OneDrive files, and SharePoint data) or to data in other external sources such as Google, Facebook, LinkedIn, SalesForce, and GitHub.</span></span> <span data-ttu-id="885b8-108">此任务被称为“加载项（或应用）授权”，因为要获得授权的是*加载项*，而不是用户。</span><span class="sxs-lookup"><span data-stu-id="885b8-108">This task is called add-in (or app) authorization, because it is the *add-in* that is being authorized, not the user.</span></span>

<span data-ttu-id="885b8-109">有两种方式可用来完成这些身份验证。</span><span class="sxs-lookup"><span data-stu-id="885b8-109">You have a choice of two ways to accomplish these authentications.</span></span>

- <span data-ttu-id="885b8-110">**Office 单一登录 (SSO)**：一种可让用户登录到 Office 从而还可用于登录到加载项的系统。</span><span class="sxs-lookup"><span data-stu-id="885b8-110">**Office Single Sign-on (SSO)**: A system that enables the user's login to Office to also function as a login to the add-in.</span></span> <span data-ttu-id="885b8-111">此外，此加载项还可使用用户的 Office 凭据向加载项授予对 Microsoft Graph 的权限。</span><span class="sxs-lookup"><span data-stu-id="885b8-111">Optionally, the add-in can also use the user's Office credentials to authorize the add-in to Microsoft Graph.</span></span> <span data-ttu-id="885b8-112">（不可通过此系统访问非 Microsoft 源。）</span><span class="sxs-lookup"><span data-stu-id="885b8-112">(Non-Microsoft sources are not accessible through this system.)</span></span>
- <span data-ttu-id="885b8-113">**通过 Azure Active Directory 进行 Web 身份验证和授权**：这是老生常谈，没有特别之处。</span><span class="sxs-lookup"><span data-stu-id="885b8-113">**Web Application Authentication and Authorization with Azure Active Directory**: This isn't something new or special.</span></span> <span data-ttu-id="885b8-114">它只是在出现 Office SSO 系统之前 Office 加载项（及其他 Web 应用）对用户进行身份验证和授权应用的方式，现在仍在 Office SSO 不可用的场景中使用。</span><span class="sxs-lookup"><span data-stu-id="885b8-114">It's just the way Office add-in (and other web apps) authenticated users and authorized apps before there was an Office SSO system and is still used in scenarios where Office SSO cannot be.</span></span>

<span data-ttu-id="885b8-115">下列流程图展示了需要如同加载项开发人员一样作出的决策。</span><span class="sxs-lookup"><span data-stu-id="885b8-115">The following flowchart shows you the decisions that you need to make as an add-in developer.</span></span> <span data-ttu-id="885b8-116">详细信息请参见本文稍后部分。</span><span class="sxs-lookup"><span data-stu-id="885b8-116">Details are later in this article.</span></span>

![一张图像，它显示了在 Office 加载项中实现身份验证和授权的决策流程图](../images/authflowchart.png)

## <a name="user-authentication-without-sso"></a><span data-ttu-id="885b8-118">在不使用 SSO 的情况下进行用户身份验证</span><span class="sxs-lookup"><span data-stu-id="885b8-118">User authentication without SSO</span></span>

<span data-ttu-id="885b8-119">你可如同在其他 Web 应用程序中操作一样使用 Azure Active Directory (AAD) 在 Office 加载项中对用户进行身份验证，但存在一个例外：AAD 禁止其登录页在 iFrame 中打开。</span><span class="sxs-lookup"><span data-stu-id="885b8-119">You can authenticate a user in an Office Add-in with Azure Active Directory (AAD) as you would in other web applications with one exception: AAD does not allow its login page to open in an iframe.</span></span> <span data-ttu-id="885b8-120">当 Office 加载项在 *Office 网页版*中运行时，任务窗格是一个 iFrame。</span><span class="sxs-lookup"><span data-stu-id="885b8-120">When an Office Add-in is running on *Office on the web*, the task pane is an iframe.</span></span> <span data-ttu-id="885b8-121">这意味着你将需要在通过 Office 对话框 API 打开的对话框中打开 AAD 登录屏幕。</span><span class="sxs-lookup"><span data-stu-id="885b8-121">This means that you'll need to open the AAD login screen in a dialog box opened with the Office dialog API.</span></span> <span data-ttu-id="885b8-122">这会影响你使用身份验证帮助程序库的方式。</span><span class="sxs-lookup"><span data-stu-id="885b8-122">This affects how you use authentication helper libraries.</span></span> <span data-ttu-id="885b8-123">有关详细信息，请参阅[使用 Office 对话框 API 进行身份验证](auth-with-office-dialog-api.md)。</span><span class="sxs-lookup"><span data-stu-id="885b8-123">For more information, see [Authentication with the Office dialog API](auth-with-office-dialog-api.md).</span></span>

<span data-ttu-id="885b8-124">有关使用 AAD 设置身份验证的信息，请先参阅[Microsoft 标识平台 (v2.0) 概览](/azure/active-directory/develop/v2-overview)，其中可找到诸多教程和指南以及相关示例和库的链接。</span><span class="sxs-lookup"><span data-stu-id="885b8-124">For information about programming authentication with AAD, begin with [Microsoft identity platform (v2.0) overview](/azure/active-directory/develop/v2-overview) where you'll find many tutorials and guides, as well as links to relevant samples and libraries.</span></span> <span data-ttu-id="885b8-125">正如[使用 Office 对话框 API 进行身份验证](auth-with-office-dialog-api.md)中所述，你可能需要调整示例中的代码以在 Office 对话框中运行。</span><span class="sxs-lookup"><span data-stu-id="885b8-125">As explained in [Authentication with the Office dialog API](auth-with-office-dialog-api.md), you may need to adjust the code in the samples to run in the Office dialog box.</span></span>

## <a name="access-to-microsoft-graph-without-sso"></a><span data-ttu-id="885b8-126">在不使用 SSO 的情况下访问 Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="885b8-126">Access to Microsoft Graph without SSO</span></span>

<span data-ttu-id="885b8-127">可通过从 Azure Active Directory (AAD) 获取到 Microsoft Graph 的访问令牌，为加载项获得到 Graph 数据的授权。</span><span class="sxs-lookup"><span data-stu-id="885b8-127">You can get authorization to Microsoft Graph data for your add-in by obtaining an access token to Graph from Azure Active Directory (AAD).</span></span> <span data-ttu-id="885b8-128">可在不依赖 Office SSO 的情况下执行此操作。</span><span class="sxs-lookup"><span data-stu-id="885b8-128">You can do this without relying on Office SSO.</span></span> <span data-ttu-id="885b8-129">要详细了解操作方式，请参阅[在不使用 SSO 的情况下访问 Microsoft Graph](authorize-to-microsoft-graph-without-sso.md)（此文中有更多详细信息和示例链接）。</span><span class="sxs-lookup"><span data-stu-id="885b8-129">For more information about how, see [Access to Microsoft Graph without SSO](authorize-to-microsoft-graph-without-sso.md) which has more details and links to samples.</span></span>

## <a name="user-authentication-with-sso"></a><span data-ttu-id="885b8-130">在使用 SSO 的情况下进行用户身份验证</span><span class="sxs-lookup"><span data-stu-id="885b8-130">User authentication with SSO</span></span>

<span data-ttu-id="885b8-131">要使用 SSO 来验证用户身份，任务窗格或函数文件中的代码会调用 [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getaccesstoken-options-) 方法。</span><span class="sxs-lookup"><span data-stu-id="885b8-131">To authenticate the user using SSO, your code in a task pane or function file calls the [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getaccesstoken-options-) method.</span></span> <span data-ttu-id="885b8-132">如果用户未登录，则 Office 将打开一个对话框，并将其导航到 Azure Active Directory 登录页面。</span><span class="sxs-lookup"><span data-stu-id="885b8-132">If the user is not signed in, Office will open a dialog box and navigate to the Azure Active Directory login page.</span></span> <span data-ttu-id="885b8-133">用户登录后或者在用户已登录时，该方法会返回一个访问令牌。</span><span class="sxs-lookup"><span data-stu-id="885b8-133">After the user signs in, or if the user is already signed in, the method returns an access token.</span></span> <span data-ttu-id="885b8-134">此令牌是**代理**流中的启动令牌。</span><span class="sxs-lookup"><span data-stu-id="885b8-134">The token is a bootstrap token in the **On Behalf Of** flow.</span></span> <span data-ttu-id="885b8-135">（详见[使用 SSO 访问 Microsoft Graph](#access-to-microsoft-graph-with-sso)。）但是，它也可用作 ID 令牌，因为它包含多个对当前用户而言唯一的声明，例如 `preferred_username`、`name`、`sub` 和 `oid`。</span><span class="sxs-lookup"><span data-stu-id="885b8-135">(See [Access to Microsoft Graph with SSO](#access-to-microsoft-graph-with-sso).) However, it can be used as an ID token as well, because it contains several claims that are unique to the current user, including `preferred_username`, `name`, `sub`, and `oid`.</span></span> <span data-ttu-id="885b8-136">要查看指南了解将哪个属性用作最终用户 ID，请参阅 [Microsoft 标识平台访问令牌](https://docs.microsoft.com/azure/active-directory/develop/access-tokens#payload-claims)。</span><span class="sxs-lookup"><span data-stu-id="885b8-136">For guidance on which property to use as the ultimate user ID, see [Microsoft identity platform access tokens](https://docs.microsoft.com/azure/active-directory/develop/access-tokens#payload-claims).</span></span> <span data-ttu-id="885b8-137">有关上述某一令牌的示例，请参阅[访问令牌示例](sso-in-office-add-ins.md#example-access-token)。</span><span class="sxs-lookup"><span data-stu-id="885b8-137">For an example of a one of these tokens, see [Example access token](sso-in-office-add-ins.md#example-access-token).</span></span>

<span data-ttu-id="885b8-138">代码从令牌中提取所需的声明后，它将使用该值在你保留的用户表或用户数据库中查找用户。</span><span class="sxs-lookup"><span data-stu-id="885b8-138">After your code has extracted the desired claim from the token, it uses that value to look up the user in a user table or user database that you maintain.</span></span> <span data-ttu-id="885b8-139">使用数据库来用户用户首选项或用户帐户状态等用户相关信息。</span><span class="sxs-lookup"><span data-stu-id="885b8-139">Use the database to store user-relative information such as the user's preferences or the state of the user's account.</span></span> <span data-ttu-id="885b8-140">由于你在使用 SSO，因此你的用户不单独登录到你的加载项，你无需存储用户的密码。</span><span class="sxs-lookup"><span data-stu-id="885b8-140">Since you are using SSO, your users don't sign-in separately to your add-in, so you do not need to store a password for the user.</span></span>

<span data-ttu-id="885b8-141">在开始使用 SSO 实现用户身份验证之前，请确保你完全熟悉[为 Office 加载项启用单一登录](sso-in-office-add-ins.md)一文。另请注意下述示例：</span><span class="sxs-lookup"><span data-stu-id="885b8-141">Before you begin implementing user authentication with SSO, be sure that you are thoroughly familiar with the article [Enable single sign-on for Office Add-ins](sso-in-office-add-ins.md). Note also these samples:</span></span>

- <span data-ttu-id="885b8-142">[Office 加载项 NodeJS SSO](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO)，特别是文件 [ssoAuthES6.js](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Complete/public/javascripts/ssoAuthES6.js)。</span><span class="sxs-lookup"><span data-stu-id="885b8-142">[Office Add-in NodeJS SSO](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO), especially the file [ssoAuthES6.js](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Complete/public/javascripts/ssoAuthES6.js).</span></span>
- <span data-ttu-id="885b8-143">[Office 加载项 ASP.NET SSO](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO)。</span><span class="sxs-lookup"><span data-stu-id="885b8-143">[Office Add-in ASP.NET SSO](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO).</span></span>

<span data-ttu-id="885b8-144">但是，这些示例不将令牌用作 ID 令牌。</span><span class="sxs-lookup"><span data-stu-id="885b8-144">These samples, however, do not use the token as an ID token.</span></span> <span data-ttu-id="885b8-145">它们使用此令牌通过**代理**流获得对 Microsoft Graph 的访问权限。</span><span class="sxs-lookup"><span data-stu-id="885b8-145">They use it to get access to Microsoft Graph with the **On Behalf Of** flow.</span></span>

## <a name="access-to-microsoft-graph-with-sso"></a><span data-ttu-id="885b8-146">在使用 SSO 的情况下访问 Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="885b8-146">Access to Microsoft Graph with SSO</span></span>

<span data-ttu-id="885b8-147">要使用 SSO 来获取访问 Microsoft Graph 的权限，任务窗格或函数文件中的加载项会调用 [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getaccesstoken-options-) 方法。</span><span class="sxs-lookup"><span data-stu-id="885b8-147">To use SSO to access Microsoft Graph, your add-in in a task pane or function file calls the [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getaccesstoken-options-) method.</span></span> <span data-ttu-id="885b8-148">如果用户未登录 Office，则 Office 将打开一个对话框，并导航到 Azure Active Directory 登录页面。</span><span class="sxs-lookup"><span data-stu-id="885b8-148">If the user is not signed in, Office will open a dialog box and navigate it to the Azure Active Directory login page.</span></span> <span data-ttu-id="885b8-149">用户登录后或者在用户已登录时，该方法会返回一个访问令牌。</span><span class="sxs-lookup"><span data-stu-id="885b8-149">After the user signs in, or if the user is already signed in, the method returns an access token.</span></span> <span data-ttu-id="885b8-150">此令牌是**代理**流中的启动令牌。</span><span class="sxs-lookup"><span data-stu-id="885b8-150">The token is a bootstrap token in the **On Behalf Of** flow.</span></span> <span data-ttu-id="885b8-151">具体而言，它有一个带 `access_as_user` 值的 `scope` 声明。</span><span class="sxs-lookup"><span data-stu-id="885b8-151">Specifically, it has a `scope` claim with the value `access_as_user`.</span></span> <span data-ttu-id="885b8-152">要在指南中了解令牌中的声明，请参阅 [Microsoft 标识平台访问令牌](https://docs.microsoft.com/azure/active-directory/develop/access-tokens#payload-claims)。</span><span class="sxs-lookup"><span data-stu-id="885b8-152">For guidance about the claims in the token, see [Microsoft identity platform access tokens](https://docs.microsoft.com/azure/active-directory/develop/access-tokens#payload-claims).</span></span> <span data-ttu-id="885b8-153">有关上述某一令牌的示例，请参阅[访问令牌示例](sso-in-office-add-ins.md#example-access-token)。</span><span class="sxs-lookup"><span data-stu-id="885b8-153">For an example of a one of these tokens, see [Example access token](sso-in-office-add-ins.md#example-access-token).</span></span>

<span data-ttu-id="885b8-154">在代码获取令牌后，它会在**代理**流中使用该令牌来获取第二个令牌，即到 Microsoft Graph 的访问令牌。</span><span class="sxs-lookup"><span data-stu-id="885b8-154">After your code obtains the token, it uses it in the **On Behalf Of** flow to obtain a second token: an access token to Microsoft Graph.</span></span>

<span data-ttu-id="885b8-155">在开始实现 Office SSO 之前，请确保你完全熟悉下面两篇文章：</span><span class="sxs-lookup"><span data-stu-id="885b8-155">Before you begin implementing Office SSO, be sure that you are thoroughly familiar with these two articles:</span></span>

- [<span data-ttu-id="885b8-156">为 Office 加载项启用单一登录</span><span class="sxs-lookup"><span data-stu-id="885b8-156">Enable single sign-on for Office Add-ins</span></span>](sso-in-office-add-ins.md)
- [<span data-ttu-id="885b8-157">使用 SSO 对 Microsoft Graph 授权</span><span class="sxs-lookup"><span data-stu-id="885b8-157">Authorize to Microsoft Graph with SSO</span></span>](authorize-to-microsoft-graph.md)

<span data-ttu-id="885b8-158">你还应至少阅读此处所列的其中一篇演示文章。</span><span class="sxs-lookup"><span data-stu-id="885b8-158">You should also read at least one of the walkthrough articles listed here.</span></span> <span data-ttu-id="885b8-159">即使你不执行这些步骤，也可在其中了解有关如何实现 Office SSO 和**代理**流的宝贵信息。</span><span class="sxs-lookup"><span data-stu-id="885b8-159">Even if you don't carry out the steps, these contain valuable information about how you implement Office SSO and the **On Behalf Of** flow.</span></span> 

- [<span data-ttu-id="885b8-160">创建使用单一登录的 ASP.NET Office 加载项</span><span class="sxs-lookup"><span data-stu-id="885b8-160">Create an ASP.NET Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-aspnet.md)
- [<span data-ttu-id="885b8-161">创建使用单一登录的 Node.js Office 加载项</span><span class="sxs-lookup"><span data-stu-id="885b8-161">Create an Node.js Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-nodejs.md)

<span data-ttu-id="885b8-162">另请注意下述示例：</span><span class="sxs-lookup"><span data-stu-id="885b8-162">Note also these samples:</span></span>

- [<span data-ttu-id="885b8-163">Office 加载项 NodeJS SSO</span><span class="sxs-lookup"><span data-stu-id="885b8-163">Office Add-in NodeJS SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO)
- [<span data-ttu-id="885b8-164">Office 加载项 ASP.NET SSO</span><span class="sxs-lookup"><span data-stu-id="885b8-164">Office Add-in ASP.NET SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO)

## <a name="access-to-non-microsoft-data-sources"></a><span data-ttu-id="885b8-165">访问非 Microsoft 数据源</span><span class="sxs-lookup"><span data-stu-id="885b8-165">Access to non-Microsoft data sources</span></span>

<span data-ttu-id="885b8-166">借助 Google、Facebook、领英、SalesForce 和 GitHub 等热门在线服务，开发人员可授权用户访问自己在其他应用中的帐户。</span><span class="sxs-lookup"><span data-stu-id="885b8-166">Popular online services, including Google, Facebook, LinkedIn, SalesForce, and GitHub, let developers give users access to their accounts in other applications.</span></span> <span data-ttu-id="885b8-167">这样，便可在 Office 加载项中添加这些服务。</span><span class="sxs-lookup"><span data-stu-id="885b8-167">This gives you the ability to include these services in your Office Add-in.</span></span> <span data-ttu-id="885b8-168">要概述了解加载项可执行此操作的方法，请参阅[在 Office 加载项中授权外部服务](auth-external-add-ins.md)。</span><span class="sxs-lookup"><span data-stu-id="885b8-168">For an overview of the ways that your add-in can do this, see [Authorize external services in your Office Add-in](auth-external-add-ins.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="885b8-169">开始编码之前，请了解数据源是否允许在 iFrame 中打开其登录屏幕。</span><span class="sxs-lookup"><span data-stu-id="885b8-169">Before you begin coding, find out if the data source allows its login in screen to open in an iframe.</span></span> <span data-ttu-id="885b8-170">当 Office 加载项在 *Office 网页版*中运行时，任务窗格是一个 iFrame。</span><span class="sxs-lookup"><span data-stu-id="885b8-170">When an Office Add-in is running on *Office on the web*, the task pane is an iframe.</span></span> <span data-ttu-id="885b8-171">如果数据源禁止在 iFrame 中打开其登录屏幕，则你需要在通过 Office 对话框 API 打开的对话框中打开登录屏幕。</span><span class="sxs-lookup"><span data-stu-id="885b8-171">If the data source does not allow its login screen to open in an iframe, then you'll need to open the login screen in a dialog box opened with the Office dialog API.</span></span> <span data-ttu-id="885b8-172">有关详细信息，请参阅[使用 Office 对话框 API 进行身份验证](auth-with-office-dialog-api.md)。</span><span class="sxs-lookup"><span data-stu-id="885b8-172">For more information, see [Authentication with the Office dialog API](auth-with-office-dialog-api.md).</span></span>
