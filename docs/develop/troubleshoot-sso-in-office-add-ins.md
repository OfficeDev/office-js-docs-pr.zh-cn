---
title: 排查单一登录 (SSO) 错误消息
description: ''
ms.date: 12/08/2017
ms.openlocfilehash: 8906a168db7be938ecc572ad41a9feec2500c189
ms.sourcegitcommit: 4de2a1b62ccaa8e51982e95537fc9f52c0c5e687
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/10/2018
ms.locfileid: "22925498"
---
# <a name="troubleshoot-error-messages-for-single-sign-on-sso-preview"></a><span data-ttu-id="91139-102">排查单一登录 (SSO) 错误消息（预览）</span><span class="sxs-lookup"><span data-stu-id="91139-102">Troubleshoot error messages for single sign-on (SSO) (preview)</span></span>

<span data-ttu-id="91139-103">本文提供了一些指南，介绍了如何排查 Office 加载项中出现的单一登录 (SSO) 问题，以及如何让已启用 SSO 的加载项可靠地处理特殊条件或错误。</span><span class="sxs-lookup"><span data-stu-id="91139-103">This article provides some guidance about how to troubleshoot problems with single sign-on (SSO) in Office Add-ins, and how to make your SSO-enabled add-in robustly handle special conditions or errors.</span></span>

## <a name="debugging-tools"></a><span data-ttu-id="91139-104">调试工具</span><span class="sxs-lookup"><span data-stu-id="91139-104">Debugging tools</span></span>

<span data-ttu-id="91139-p101">开发时，强烈建议使用具有以下功能的工具：能够截获并显示加载项 Web 服务发出的 HTTP 请求和发送给它的响应。最热门的两个工具是：</span><span class="sxs-lookup"><span data-stu-id="91139-p101">We strongly recommend that you use a tool that can intercept and display the HTTP Requests from, and Responses to, your add-in's web service when you are developing. Two of the most popular are:</span></span> 

- <span data-ttu-id="91139-107">[Fiddler](http://www.telerik.com/fiddler)：免费使用（[文档](http://docs.telerik.com/fiddler/configure-fiddler/tasks/configurefiddler)）</span><span class="sxs-lookup"><span data-stu-id="91139-107">[Fiddler](http://www.telerik.com/fiddler): Free ([Documentation](http://docs.telerik.com/fiddler/configure-fiddler/tasks/configurefiddler))</span></span>
- <span data-ttu-id="91139-p102">[Charles](https://www.charlesproxy.com/)：免费使用 30 天。（[文档](https://www.charlesproxy.com/documentation/)）</span><span class="sxs-lookup"><span data-stu-id="91139-p102">[Charles](https://www.charlesproxy.com/): Free for 30 days. ([Documenation](https://www.charlesproxy.com/documentation/))</span></span>

<span data-ttu-id="91139-110">开发服务 API 时，不妨还尝试使用：</span><span class="sxs-lookup"><span data-stu-id="91139-110">When developing your service API, you may also want to try:</span></span>

- <span data-ttu-id="91139-111">[Postman](http://www.getpostman.com/postman)：免费使用（[文档](https://www.getpostman.com/docs/)）</span><span class="sxs-lookup"><span data-stu-id="91139-111">[Postman](http://www.getpostman.com/postman): Free ([Documentation](https://www.getpostman.com/docs/))</span></span>

## <a name="causes-and-handling-of-errors-from-getaccesstokenasync"></a><span data-ttu-id="91139-112">导致 getAccessTokenAsync 生成错误的原因和处理方法</span><span class="sxs-lookup"><span data-stu-id="91139-112">Causes and handling of errors from getAccessTokenAsync</span></span>

<span data-ttu-id="91139-113">有关此部分中介绍的错误处理示例，请参阅：</span><span class="sxs-lookup"><span data-stu-id="91139-113">For examples of the error handling described in this section, see:</span></span>
- [<span data-ttu-id="91139-114">Office-Add-in-ASPNET-SSO 中的 Home.js</span><span class="sxs-lookup"><span data-stu-id="91139-114">Home.js in Office-Add-in-ASPNET-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/Home.js)
- [<span data-ttu-id="91139-115">Office-Add-in-NodeJS-SSO 中的 program.js</span><span class="sxs-lookup"><span data-stu-id="91139-115">program.js in Office-Add-in-NodeJS-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Completed/public/program.js)

> [!NOTE]
> <span data-ttu-id="91139-116">除了本节中提出的建议之外，Outlook加载项还有一个额外的方式来响应任何13*nnn*错误。</span><span class="sxs-lookup"><span data-stu-id="91139-116">Besides the suggestions made in this section, an Outlook add-in has an additional way to respond to any 13*nnn* error.</span></span> <span data-ttu-id="91139-117">预知详情，请参阅 [方案：在 Outlook 加载项中实施单一登录到您的服务](https://docs.microsoft.com/outlook/add-ins/implement-sso-in-outlook-add-in)和 [ AttachmentsDemo 示例加载项](https://github.com/OfficeDev/outlook-add-in-attachments-demo)。</span><span class="sxs-lookup"><span data-stu-id="91139-117">For more details, see [Scenario: Implement single sign-on to your service in an Outlook Add-in](https://docs.microsoft.com/outlook/add-ins/implement-sso-in-outlook-add-in).</span></span> 

### <a name="13000"></a><span data-ttu-id="91139-118">13000</span><span class="sxs-lookup"><span data-stu-id="91139-118">Default: 13000</span></span>

<span data-ttu-id="91139-119">加载项或 Office 版本不支持 [getAccessTokenAsync](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync) API。</span><span class="sxs-lookup"><span data-stu-id="91139-119">The [getAccessTokenAsync](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync) API is not supported by the add-in or the Office version.</span></span> 

- <span data-ttu-id="91139-p104">Office 版本不支持 SSO。必须为 Office 2016 版本 1710（生成号 8629.nnnn）或更高版本（Office 365 订阅版本，有时亦称为“即点即用”）。可能必须成为 Office 预览体验成员，才能获取此版本。有关详细信息，请参阅[成为 Office 预览体验成员](https://products.office.com/office-insider?tab=tab-1)。</span><span class="sxs-lookup"><span data-stu-id="91139-p104">The version of Office does not support SSO. The required version is Office 2016, Version 1710, build 8629.nnnn or later (the Office 365 subscription version, sometimes called “Click to Run”). You might need to be an Office Insider to get this version. For more information, see [Be an Office Insider](https://products.office.com/office-insider?tab=tab-1).</span></span> 
- <span data-ttu-id="91139-124">加载项清单缺少适当的 [WebApplicationInfo](https://dev.office.com/reference/add-ins/manifest/webapplicationinfo) 部分。</span><span class="sxs-lookup"><span data-stu-id="91139-124">The add-in manifest is missing the proper [WebApplicationInfo](https://dev.office.com/reference/add-ins/manifest/webapplicationinfo) section.</span></span>

### <a name="13001"></a><span data-ttu-id="91139-125">13001</span><span class="sxs-lookup"><span data-stu-id="91139-125">13001</span></span>

<span data-ttu-id="91139-126">用户未登录 Office。</span><span class="sxs-lookup"><span data-stu-id="91139-126">The user is not signed into Office.</span></span> <span data-ttu-id="91139-127">您的代码应撤回 `getAccessTokenAsync` 方法并传递选项 `forceAddAccount: true`在 [选项s](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters)参数中。</span><span class="sxs-lookup"><span data-stu-id="91139-127">Your code should recall the `getAccessTokenAsync` method and pass the option `forceAddAccount: true` in the [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters) parameter.</span></span> <span data-ttu-id="91139-128">但只能执行一次。</span><span class="sxs-lookup"><span data-stu-id="91139-128">But don't do this more than once.</span></span> <span data-ttu-id="91139-129">用户可能已决定不登录。</span><span class="sxs-lookup"><span data-stu-id="91139-129">The user may have decided not to sign-in.</span></span>

<span data-ttu-id="91139-130">Office Online 中绝不会出现此错误。</span><span class="sxs-lookup"><span data-stu-id="91139-130">This error is never seen in Office Online.</span></span> <span data-ttu-id="91139-131">如果用户的 Cookie 到期，Office Online 返回的是错误 13006。</span><span class="sxs-lookup"><span data-stu-id="91139-131">If the user's cookie expires, Office Online returns error 13006.</span></span> 

### <a name="13002"></a><span data-ttu-id="91139-132">13002</span><span class="sxs-lookup"><span data-stu-id="91139-132">13002</span></span>

<span data-ttu-id="91139-133">用户放弃了登录或许可；例如，在许可对话框上 **取消**。</span><span class="sxs-lookup"><span data-stu-id="91139-133">The user aborted sign in or consent; for example, by choosing **Cancel** on the consent dialog.</span></span> 
- <span data-ttu-id="91139-134">如果加载项提供的功能无需用户登录（或授予许可），代码应捕获此错误，并让加载项继续正常运行。</span><span class="sxs-lookup"><span data-stu-id="91139-134">If your add-in provides functions that don't require the user to be signed in (or to have granted consent), then your code should catch this error and allow the add-in to stay running.</span></span>
- <span data-ttu-id="91139-135">如果加载项需要登录用户授予许可，代码应提示用户重复执行操作，但只能重复一次。</span><span class="sxs-lookup"><span data-stu-id="91139-135">If the add-in requires a signed-in user who has granted consent, your code should ask the user to repeat the operation, but not more than once.</span></span> 

### <a name="13003"></a><span data-ttu-id="91139-136">13003</span><span class="sxs-lookup"><span data-stu-id="91139-136">13003</span></span>

<span data-ttu-id="91139-137">用户类型不受支持。</span><span class="sxs-lookup"><span data-stu-id="91139-137">User Type not supported.</span></span> <span data-ttu-id="91139-138">用户未使用有效的 Microsoft 帐户/工作或学校帐户登录 Office。</span><span class="sxs-lookup"><span data-stu-id="91139-138">The user isn't signed into Office with a valid Microsoft Account or Work or School account.</span></span> <span data-ttu-id="91139-139">例如，当使用本地域帐户运行 Office 时，可能会生成此错误。</span><span class="sxs-lookup"><span data-stu-id="91139-139">This may happen if Office runs with an on-premises domain account, for example.</span></span> <span data-ttu-id="91139-140">代码应提示用户登录 Office。</span><span class="sxs-lookup"><span data-stu-id="91139-140">Your code should ask the user to sign in to Office.</span></span>

### <a name="13004"></a><span data-ttu-id="91139-141">13004</span><span class="sxs-lookup"><span data-stu-id="91139-141">13004</span></span>

<span data-ttu-id="91139-142">资源无效。</span><span class="sxs-lookup"><span data-stu-id="91139-142">Invalid Resource.</span></span> <span data-ttu-id="91139-143">加载项清单未正确配置。</span><span class="sxs-lookup"><span data-stu-id="91139-143">The add-in manifest hasn’t been configured correctly.</span></span> <span data-ttu-id="91139-144">请更新此清单。</span><span class="sxs-lookup"><span data-stu-id="91139-144">Update the manifest.</span></span> <span data-ttu-id="91139-145">预知详细信息，请参阅[验证并排查您的清单问题](../testing/troubleshoot-manifest.md)。</span><span class="sxs-lookup"><span data-stu-id="91139-145">For more information, see [Validate and troubleshoot issues with your manifest](../testing/troubleshoot-manifest.md).</span></span> <span data-ttu-id="91139-146">最常见的问题是，**Resource**元素（ 在**WebApplicationInfo**元素中 ）具有与加载项的域不匹配的域。</span><span class="sxs-lookup"><span data-stu-id="91139-146">The most commmon problem is that the **Resource** element (in the **WebApplicationInfo** element) has a domain that does not match the domain of the add-in.</span></span> <span data-ttu-id="91139-147">尽管资源值的协议部分应为"api"而不是"https";域名的所有其他部分（包括端口，如果有的话）应与加载项的相同。</span><span class="sxs-lookup"><span data-stu-id="91139-147">Although the protocol part of the Resource value should be "api" not "https"; all other parts of the domain name (including port, if any) should be the same as for the add-in.</span></span>

### <a name="13005"></a><span data-ttu-id="91139-148">13005</span><span class="sxs-lookup"><span data-stu-id="91139-148">13005</span></span>

<span data-ttu-id="91139-149">授权无效。</span><span class="sxs-lookup"><span data-stu-id="91139-149">Invalid Grant.</span></span> <span data-ttu-id="91139-150">这通常意味着，Office 尚未获得对加载项 Web 服务的预授权。</span><span class="sxs-lookup"><span data-stu-id="91139-150">This usually means that Office has not been pre-authorized to the add-in's web service.</span></span> <span data-ttu-id="91139-151">有关详细信息，请参阅[创建服务应用程序](sso-in-office-add-ins.md#create-the-service-application)和[向 Azure AD v2.0 终结点注册加载项](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) 或[向 Azure AD v2.0 终结点注册加载项](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS)。</span><span class="sxs-lookup"><span data-stu-id="91139-151">For more information, see [Create the service application](sso-in-office-add-ins.md#create-the-service-application) and [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) or [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS).</span></span> <span data-ttu-id="91139-152">如果用户尚未将您的服务应用程序权限授予其也可能发生这个情况。`profile`</span><span class="sxs-lookup"><span data-stu-id="91139-152">This also may happen if the user has not granted your service application permissions to his or her `profile`.</span></span>

### <a name="13006"></a><span data-ttu-id="91139-153">13006</span><span class="sxs-lookup"><span data-stu-id="91139-153">13006</span></span>

<span data-ttu-id="91139-p110">客户端错误。代码应提示用户注销并重启 Office，或重启 Office Online 会话。</span><span class="sxs-lookup"><span data-stu-id="91139-p110">Client Error. Your code should suggest that the user sign out and restart Office, or restart the Office Online session.</span></span>

### <a name="13007"></a><span data-ttu-id="91139-156">13007</span><span class="sxs-lookup"><span data-stu-id="91139-156">13007</span></span>

<span data-ttu-id="91139-157">Office 主机无法获取对加载项网页服务的访问令牌。</span><span class="sxs-lookup"><span data-stu-id="91139-157">The Office host was unable to get an access token to the add-in's web service.</span></span>
- <span data-ttu-id="91139-158">如果在开发过程中发生此错误，请确保您的加载项注册和加载项清单指定了 `openid` 和 `profile`权限。</span><span class="sxs-lookup"><span data-stu-id="91139-158">If this error occurs during development, be sure that your add-in registration and add-in manifest specify the `openid` and `profile` permissions.</span></span> <span data-ttu-id="91139-159">有关详细信息，请参阅[向 Azure AD v2.0 终结点注册加载项](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) 或[向 Azure AD v2.0 终结点注册加载项](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS)，以及[配置加载项](create-sso-office-add-ins-aspnet.md#configure-the-add-in) (ASP.NET) 或[配置加载项](create-sso-office-add-ins-nodejs.md#configure-the-add-in) (Node JS)。</span><span class="sxs-lookup"><span data-stu-id="91139-159">For more information, see [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) or [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS), and [Configure the add-in](create-sso-office-add-ins-aspnet.md#configure-the-add-in) (ASP.NET) or [Configure the add-in](create-sso-office-add-ins-nodejs.md#configure-the-add-in) (Node JS).</span></span>
- <span data-ttu-id="91139-160">在生产中，有几种情况会导致这个错误。</span><span class="sxs-lookup"><span data-stu-id="91139-160">In production, there are several things that can cause this error.</span></span> <span data-ttu-id="91139-161">其中包括：</span><span class="sxs-lookup"><span data-stu-id="91139-161">Some of them are:</span></span>
    - <span data-ttu-id="91139-162">用户在授予许可后，又撤销了许可。</span><span class="sxs-lookup"><span data-stu-id="91139-162">The user has revoked consent, after previously granting it.</span></span> <span data-ttu-id="91139-163">您的代码应该撤回 `getAccessTokenAsync` 方法，使用选项`forceConsent: true`，但不能超过一次。</span><span class="sxs-lookup"><span data-stu-id="91139-163">Your code should recall the `getAccessTokenAsync` method with the option `forceConsent: true`, but no more than once.</span></span>
    - <span data-ttu-id="91139-164">该用户拥有 Microsoft帐户 （MSA）标识。</span><span class="sxs-lookup"><span data-stu-id="91139-164">The user is has an Microsoft Account (MSA) identity.</span></span> <span data-ttu-id="91139-165">使用工作或学校帐户，某些情况会导致其他13nnn错误之一，使用MSA将导致13007。</span><span class="sxs-lookup"><span data-stu-id="91139-165">Some situations that would cause one of the other 13nnn errors with a Work or School account, will cause a 13007 when a MSA is used.</span></span> 

  <span data-ttu-id="91139-166">对于所有这些情况，如果您已经尝试过 `forceConsent` 选项一次，那么您的代码可能会建议用户稍后重试操作。</span><span class="sxs-lookup"><span data-stu-id="91139-166">For all of these cases, if you have already tried the `forceConsent` option once, then your code could suggest that the user retry the operation later.</span></span>

### <a name="13008"></a><span data-ttu-id="91139-167">13008</span><span class="sxs-lookup"><span data-stu-id="91139-167">13008</span></span>

<span data-ttu-id="91139-168">用户在上一次调用 `getAccessTokenAsync` 完成前触发了调用 `getAccessTokenAsync` 的操作。</span><span class="sxs-lookup"><span data-stu-id="91139-168">The user triggered an operation that calls `getAccessTokenAsync` before a previous call of `getAccessTokenAsync` completed.</span></span> <span data-ttu-id="91139-169">代码应提示用户在上一次操作完成后再重复此操作。</span><span class="sxs-lookup"><span data-stu-id="91139-169">Your code should ask the user to repeat the operation after the previous operation has completed.</span></span>

### <a name="13009"></a><span data-ttu-id="91139-170">13009</span><span class="sxs-lookup"><span data-stu-id="91139-170">13009</span></span>

<span data-ttu-id="91139-171">加载项使用选项 `forceConsent: true` 调用了 `getAccessTokenAsync` 方法，但加载项清单部署到的目录类型不支持强制许可。</span><span class="sxs-lookup"><span data-stu-id="91139-171">The add-in called the `getAccessTokenAsync` method with the option `forceConsent: true`, but the add-in's manifest is deployed to a type of catalog that does not support forcing consent.</span></span> <span data-ttu-id="91139-172">代码应重新调用 `getAccessTokenAsync` 方法，并在 [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters) 参数中传递选项 `forceConsent: false`。</span><span class="sxs-lookup"><span data-stu-id="91139-172">Your code should recall the `getAccessTokenAsync` method and pass the option `forceConsent: false` in the [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters) parameter.</span></span> <span data-ttu-id="91139-173">不过，使用 `forceConsent: true` 调用 `getAccessTokenAsync` 本身就是在自动响应使用 `forceConsent: false` 调用 `getAccessTokenAsync` 时出现的错误。因此，代码应跟踪是否已使用 `forceConsent: false` 调用 `getAccessTokenAsync`。</span><span class="sxs-lookup"><span data-stu-id="91139-173">However, the call of  `getAccessTokenAsync`  with `forceConsent: true` might itself have been an automatic response to a failed call of `getAccessTokenAsync` with `forceConsent: false`, so your code should keep track of whether `getAccessTokenAsync` with `forceConsent: false` has already been called.</span></span> <span data-ttu-id="91139-174">如果已调用，代码应提示用户注销并重新登录Office。</span><span class="sxs-lookup"><span data-stu-id="91139-174">If it has, your code should tell the user to sign out of Office and sign-in again.</span></span>

> [!NOTE]
> <span data-ttu-id="91139-175">Microsoft 不一定会将此限制施加于所有类型的插件目录。</span><span class="sxs-lookup"><span data-stu-id="91139-175">Microsoft will not necessarilly impose this restriction on any types of add-in catalogs.</span></span> <span data-ttu-id="91139-176">如果没有，则永远不会出现此错误。</span><span class="sxs-lookup"><span data-stu-id="91139-176">If it doesn't, then this error will never be seen.</span></span>

### <a name="13010"></a><span data-ttu-id="91139-177">13010</span><span class="sxs-lookup"><span data-stu-id="91139-177">13010</span></span>

<span data-ttu-id="91139-178">用户正在 Office Online 上运行加载项，但使用的是 Edge 或 Internet Explorer。</span><span class="sxs-lookup"><span data-stu-id="91139-178">The user is running the add-in on Office Online and is using Edge or Internet Explorer.</span></span> <span data-ttu-id="91139-179">用户的 Office 365 域和 login.microsoftonline.com 域位于浏览器设置中的不同安全区域。</span><span class="sxs-lookup"><span data-stu-id="91139-179">The user’s Office 365 domain, and the login.microsoftonline.com domain, are in a different security zones in the browser settings.</span></span> <span data-ttu-id="91139-180">如果此错误返回，用户将已看到对此进行解释的错误，并链接到关于如何更改区域配置的页面。</span><span class="sxs-lookup"><span data-stu-id="91139-180">If this error is returned, the user will have already seen an error explaining this and linking to a page about how to change the zone configuration.</span></span> <span data-ttu-id="91139-181">如果加载项提供的功能无需用户登录，代码应捕获此错误，并让加载项继续正常运行。</span><span class="sxs-lookup"><span data-stu-id="91139-181">If your add-in provides functions that don't require the user to be signed in, then your code should catch this error and allow the add-in to stay running.</span></span>

### <a name="50001"></a><span data-ttu-id="91139-182">50001</span><span class="sxs-lookup"><span data-stu-id="91139-182">50001</span></span>

<span data-ttu-id="91139-183">这个错误（并非特定于 `getAccessTokenAsync`）可能表示浏览器已兑现了 office.js 文件的一个旧副本。</span><span class="sxs-lookup"><span data-stu-id="91139-183">This error (which is not specific to `getAccessTokenAsync`) may indicate that the browser has cashed an old copy of the office.js files.</span></span> <span data-ttu-id="91139-184">清除浏览器的缓存。</span><span class="sxs-lookup"><span data-stu-id="91139-184">Clear the Office cache</span></span> <span data-ttu-id="91139-185">另一种可能性是 Office 的版本不够新，无法支持 SSO。</span><span class="sxs-lookup"><span data-stu-id="91139-185">Another possibility is that the version of Office is not recent enough to support SSO.</span></span> <span data-ttu-id="91139-186">请参阅 [先决条件](create-sso-office-add-ins-aspnet.md#prerequisites)。</span><span class="sxs-lookup"><span data-stu-id="91139-186">See [Prerequisites](create-sso-office-add-ins-aspnet.md#prerequisites).</span></span>

## <a name="errors-on-the-server-side-from-azure-active-directory"></a><span data-ttu-id="91139-187">在 Azure Active Directory 服务器端出现错误</span><span class="sxs-lookup"><span data-stu-id="91139-187">Errors on the server-side from Azure Active Directory</span></span>

<span data-ttu-id="91139-188">有关此部分中介绍的错误处理示例，请参阅：</span><span class="sxs-lookup"><span data-stu-id="91139-188">For samples of the error-handling described in this section, see:</span></span>
- [<span data-ttu-id="91139-189">Office-Add-in-ASPNET-SSO</span><span class="sxs-lookup"><span data-stu-id="91139-189">Office-Add-in-ASPNET-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO)
- [<span data-ttu-id="91139-190">Office-Add-in-NodeJS-SSO</span><span class="sxs-lookup"><span data-stu-id="91139-190">Office-Add-in-NodeJS-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO)


### <a name="conditional-access--multifactor-authentication-errors"></a><span data-ttu-id="91139-191">条件访问/多重身份验证错误</span><span class="sxs-lookup"><span data-stu-id="91139-191">Conditional access / Multifactor authentication errors</span></span>
 
<span data-ttu-id="91139-192">在特定 AAD 和 Office 365 标识配置中，一些可通过 Microsoft Graph 访问的资源可以要求进行多重身份验证 (MFA)，即使用户的 Office 365 租赁并不要求此验证。</span><span class="sxs-lookup"><span data-stu-id="91139-192">In certain configurations of identity in AAD and Office 365, it is possible for some resources that are accessible with Microsoft Graph to require multifactor authentication (MFA), even when the user's Office 365 tenancy does not.</span></span> <span data-ttu-id="91139-193">通过代表流收到对 MFA 保护资源的令牌请求时，AAD 会向加载项 Web 服务返回包含 `claims` 属性的 JSON 消息。</span><span class="sxs-lookup"><span data-stu-id="91139-193">When AAD receives a request for a token to the MFA-protected resource, via the on-behalf-of flow, it returns to your add-in's web service a JSON message that contains a `claims` property.</span></span> <span data-ttu-id="91139-194">claims 属性指明需要进一步执行哪几重身份验证。</span><span class="sxs-lookup"><span data-stu-id="91139-194">The claims property has information about what further authentication factors are needed.</span></span> 

<span data-ttu-id="91139-195">服务器端代码应测试此消息是否有错，并将 claims 值中继到客户端代码。</span><span class="sxs-lookup"><span data-stu-id="91139-195">Your server-side code should test for this message and relay the claims value to your client-side code.</span></span> <span data-ttu-id="91139-196">客户端需要此信息，因为 Office 处理 SSO 加载项的身份验证。发送到客户端的消息可以是错误（如 `500 Server Error` 或 `401 Unauthorized`），也可以是成功响应的正文部分（如 `200 OK`）。</span><span class="sxs-lookup"><span data-stu-id="91139-196">You need this information in the client because Office handles authentication for SSO add-ins. The message to the client can be either an error (such as `500 Server Error` or `401 Unauthorized`) or in the body of a success response (such as `200 OK`).</span></span> <span data-ttu-id="91139-197">无论属于上述哪种情况，代码对加载项 Web API 的客户端 AJAX 调用的（失败或成功）回调都应测试此响应是否有错。</span><span class="sxs-lookup"><span data-stu-id="91139-197">In either case, the (failure or success) callback of your code's client-side AJAX call to your add-in's web API should test for this response.</span></span> <span data-ttu-id="91139-198">如果已中继 claims 值，代码应重新调用 `getAccessTokenAsync`，并在 [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters) 参数中传递选项 `authChallenge: CLAIMS-STRING-HERE`。</span><span class="sxs-lookup"><span data-stu-id="91139-198">If the claims value has been relayed, your code should recall `getAccessTokenAsync` and pass the option `authChallenge: CLAIMS-STRING-HERE` in the [options](https://dev.office.com/reference/add-ins/shared/office.context.auth.getAccessTokenAsync#parameters) parameter.</span></span> <span data-ttu-id="91139-199">如果 AAD 看到此字符串，它会先提示用户进行多重身份验证，再返回将在代表流中接受的新访问令牌。</span><span class="sxs-lookup"><span data-stu-id="91139-199">When AAD sees this string, it prompts the user for the additional factor(s) and then returns a new access token which will be accepted in the on-behalf-of flow.</span></span>

### <a name="consent-missing-errors"></a><span data-ttu-id="91139-200">缺少许可错误</span><span class="sxs-lookup"><span data-stu-id="91139-200">Consent missing errors</span></span>

<span data-ttu-id="91139-201">如果 AAD 未记录用户（或租户管理员）已授权加载项访问 Microsoft Graph 资源，AAD 会向 Web 服务发送错误消息。</span><span class="sxs-lookup"><span data-stu-id="91139-201">If AAD has no record that consent (to the Microsoft Graph resource) was granted to the add-in by the user (or tenant administrator), AAD will send an error message to your web service.</span></span> <span data-ttu-id="91139-202">代码必须指示客户端（例如，在 `403 Forbidden` 响应的正文中）通过 `forceConsent: true` 选项重新调用 `getAccessTokenAsync`。</span><span class="sxs-lookup"><span data-stu-id="91139-202">Your code must tell the client (in the body of a `403 Forbidden` response, for example) to recall `getAccessTokenAsync` with the `forceConsent: true` option.</span></span>

### <a name="invalid-or-missing-scope-permission-errors"></a><span data-ttu-id="91139-203">范围（权限）无效或缺失错误</span><span class="sxs-lookup"><span data-stu-id="91139-203">Invalid or missing scope (permission) errors</span></span>

- <span data-ttu-id="91139-p123">服务器端代码应向客户端发送 `403 Forbidden` 响应，向用户显示易记消息。如果可能，请在控制台或日志中记录此错误。</span><span class="sxs-lookup"><span data-stu-id="91139-p123">Your server-side code should send a `403 Forbidden` response to the client which should present a friendly message to the user. If possible, log the error to the console or record it in a log.</span></span>
- <span data-ttu-id="91139-206">请确保加载项清单 [Scopes](https://dev.office.com/reference/add-ins/manifest/scopes) 部分指定了所需的全部权限。</span><span class="sxs-lookup"><span data-stu-id="91139-206">Be sure your add-in manifest [Scopes](https://dev.office.com/reference/add-ins/manifest/scopes)  section specifies all needed permissions.</span></span> <span data-ttu-id="91139-207">此外，还请确保加载项 Web 服务注册指定了相同的权限。</span><span class="sxs-lookup"><span data-stu-id="91139-207">And be sure your registration of the add-in's web service specifies the same permissions.</span></span> <span data-ttu-id="91139-208">同时检查是否有拼写错误。</span><span class="sxs-lookup"><span data-stu-id="91139-208">Check for spelling mistakes too.</span></span> <span data-ttu-id="91139-209">有关详细信息，请参阅[向 Azure AD v2.0 终结点注册加载项](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) 或[向 Azure AD v2.0 终结点注册加载项](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS)，以及[配置加载项](create-sso-office-add-ins-aspnet.md#configure-the-add-in) (ASP.NET) 或[配置加载项](create-sso-office-add-ins-nodejs.md#configure-the-add-in) (Node JS)。</span><span class="sxs-lookup"><span data-stu-id="91139-209">For more information, see [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-aspnet.md#register-the-add-in-with-azure-ad-v20-endpoint) (ASP.NET) or [Register the add-in with Azure AD v2.0 endpoint](create-sso-office-add-ins-nodejs.md#register-the-add-in-with-azure-ad-v20-endpoint) (Node JS), and [Configure the add-in](create-sso-office-add-ins-aspnet.md#configure-the-add-in) (ASP.NET) or [Configure the add-in](create-sso-office-add-ins-nodejs.md#configure-the-add-in) (Node JS).</span></span>

### <a name="expired-or-invalid-token-errors-when-calling-microsoft-graph"></a><span data-ttu-id="91139-210">调用 Microsoft Graph 时令牌过期或无效错误</span><span class="sxs-lookup"><span data-stu-id="91139-210">Expired or invalid token errors when calling Microsoft Graph</span></span>

<span data-ttu-id="91139-211">一些身份验证和授权库（包括 MSAL）在必要时使用缓存的刷新令牌，防止出现令牌过期错误。</span><span class="sxs-lookup"><span data-stu-id="91139-211">Some authentication and authorization libraries, including MSAL, prevent expired token errors by using a cached refresh token whenever necessary.</span></span> <span data-ttu-id="91139-212">也可以编码自己的令牌缓存系统。</span><span class="sxs-lookup"><span data-stu-id="91139-212">You can also code your own token caching system.</span></span> <span data-ttu-id="91139-213">有关如何这样做的示例，请参阅 [Office 加载项 NodeJS SSO](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO)，并重点参阅 [auth.ts](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Completed/src/auth.ts) 文件。</span><span class="sxs-lookup"><span data-stu-id="91139-213">For a sample that does this, see [Office Add-in NodeJS SSO](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO), especially the file [auth.ts](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Completed/src/auth.ts).</span></span>

<span data-ttu-id="91139-214">不过，如果收到了令牌过期或令牌无效错误，代码必须指示客户端（例如，在 `401 Unauthorized` 响应的正文中）重新调用 `getAccessTokenAsync`，并重复调用加载项 Web API 终结点，这会重复执行代表流来获取新 Microsoft Graph 令牌。</span><span class="sxs-lookup"><span data-stu-id="91139-214">But if you get an expired token or invalid token error, your code must tell the client (in the body of a `401 Unauthorized` response, for example) to recall `getAccessTokenAsync` and repeat the call to the endpoint of your add-in's web API, which will repeat the on-behalf-of flow to obtain a new token for Microsoft Graph.</span></span> 

### <a name="invalid-token-error-when-calling-microsoft-graph"></a><span data-ttu-id="91139-215">调用 Microsoft Graph 时令牌无效错误</span><span class="sxs-lookup"><span data-stu-id="91139-215">Invalid token error when calling Microsoft Graph</span></span>

<span data-ttu-id="91139-p126">按照处理令牌到期错误的方法处理此错误。请参阅上一部分。</span><span class="sxs-lookup"><span data-stu-id="91139-p126">Handle this error the same as an expired token error. See previous section.</span></span>

### <a name="invalid-audience-error"></a><span data-ttu-id="91139-218">受众无效错误</span><span class="sxs-lookup"><span data-stu-id="91139-218">Invalid audience error</span></span>

<span data-ttu-id="91139-219">服务器端代码应向客户端发送 `403 Forbidden` 响应，向用户显示易记消息，并尽可能在控制台或日志中记录此错误。</span><span class="sxs-lookup"><span data-stu-id="91139-219">Your server-side code should send a `403 Forbidden` response to the client which should present a friendly message to the user and possibly also log the error to the console or record it in a log.</span></span>

<span data-ttu-id="91139-220">若要详细了解如何添加令牌验证的多租户支持，请参阅 [Azure 多租户示例](https://github.com/Azure-Samples/active-directory-dotnet-webapp-webapi-multitenant-openidconnect)。</span><span class="sxs-lookup"><span data-stu-id="91139-220">For more on adding multitenant support for token validation, see the [Azure Multitenant Sample](https://github.com/Azure-Samples/active-directory-dotnet-webapp-webapi-multitenant-openidconnect).</span></span>
