---
title: 排查单一登录 (SSO) 错误消息
description: 有关如何解决单一登录 (SSO) 在 Office 外接程序中的问题，以及如何处理特殊条件或错误的指南。
ms.date: 07/30/2020
localization_priority: Normal
ms.openlocfilehash: b8578f103c0b4e31523a3c4f99f4eac6ec544b2b
ms.sourcegitcommit: 9609bd5b4982cdaa2ea7637709a78a45835ffb19
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/28/2020
ms.locfileid: "47293133"
---
# <a name="troubleshoot-error-messages-for-single-sign-on-sso"></a><span data-ttu-id="c9916-103">排查单一登录 (SSO) 错误消息</span><span class="sxs-lookup"><span data-stu-id="c9916-103">Troubleshoot error messages for single sign-on (SSO)</span></span>

<span data-ttu-id="c9916-104">本文提供了一些指南，介绍了如何排查 Office 加载项中出现的单一登录 (SSO) 问题，以及如何让已启用 SSO 的加载项可靠地处理特殊条件或错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-104">This article provides some guidance about how to troubleshoot problems with single sign-on (SSO) in Office Add-ins, and how to make your SSO-enabled add-in robustly handle special conditions or errors.</span></span>

> [!NOTE]
> <span data-ttu-id="c9916-105">目前，Word、Excel、Outlook 和 PowerPoint 支持单一登录 API。</span><span class="sxs-lookup"><span data-stu-id="c9916-105">The Single Sign-on API is currently supported for Word, Excel, Outlook, and PowerPoint.</span></span> <span data-ttu-id="c9916-106">若要详细了解目前支持单一登录 API 的平台，请参阅 [IdentityAPI 要求集](../reference/requirement-sets/identity-api-requirement-sets.md)。</span><span class="sxs-lookup"><span data-stu-id="c9916-106">For more information about where the Single Sign-on API is currently supported, see [IdentityAPI requirement sets](../reference/requirement-sets/identity-api-requirement-sets.md).</span></span>
> <span data-ttu-id="c9916-107">如果使用的是 Outlook 加载项，请务必为 Office 365 租赁启用新式验证。</span><span class="sxs-lookup"><span data-stu-id="c9916-107">If you are working with an Outlook add-in, be sure to enable Modern Authentication for the Office 365 tenancy.</span></span> <span data-ttu-id="c9916-108">若要了解如何执行此操作，请参阅 [Exchange Online：如何为租户启用新式验证](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c9916-108">For information about how to do this, see [Exchange Online: How to enable your tenant for modern authentication](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span></span>

## <a name="debugging-tools"></a><span data-ttu-id="c9916-109">调试工具</span><span class="sxs-lookup"><span data-stu-id="c9916-109">Debugging tools</span></span>

<span data-ttu-id="c9916-p102">开发时，强烈建议使用具有以下功能的工具：能够截获并显示加载项 Web 服务发出的 HTTP 请求和发送给它的响应。最热门的两个工具是：</span><span class="sxs-lookup"><span data-stu-id="c9916-p102">We strongly recommend that you use a tool that can intercept and display the HTTP Requests from, and Responses to, your add-in's web service when you are developing. Two of the most popular are:</span></span>

- <span data-ttu-id="c9916-112">[Fiddler](https://www.telerik.com/fiddler)：免费使用（[文档](https://docs.telerik.com/fiddler/configure-fiddler/tasks/configurefiddler)）</span><span class="sxs-lookup"><span data-stu-id="c9916-112">[Fiddler](https://www.telerik.com/fiddler): Free ([Documentation](https://docs.telerik.com/fiddler/configure-fiddler/tasks/configurefiddler))</span></span>
- <span data-ttu-id="c9916-113">[Charles](https://www.charlesproxy.com)：免费使用 30 天。</span><span class="sxs-lookup"><span data-stu-id="c9916-113">[Charles](https://www.charlesproxy.com): Free for 30 days.</span></span> <span data-ttu-id="c9916-114">（[文档](https://www.charlesproxy.com/documentation/)）</span><span class="sxs-lookup"><span data-stu-id="c9916-114">([Documentation](https://www.charlesproxy.com/documentation/))</span></span>

## <a name="causes-and-handling-of-errors-from-getaccesstoken"></a><span data-ttu-id="c9916-115">导致 getAccessToken 生成错误的原因和处理方法</span><span class="sxs-lookup"><span data-stu-id="c9916-115">Causes and handling of errors from getAccessToken</span></span>

<span data-ttu-id="c9916-116">有关此部分中介绍的错误处理示例，请参阅：</span><span class="sxs-lookup"><span data-stu-id="c9916-116">For examples of the error handling described in this section, see:</span></span>
- [<span data-ttu-id="c9916-117">Office-Add-in-ASPNET-SSO 中的 HomeES6.js</span><span class="sxs-lookup"><span data-stu-id="c9916-117">HomeES6.js in Office-Add-in-ASPNET-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/HomeES6.js)
- [<span data-ttu-id="c9916-118">ssoAuthES6.js in Office-Add-in-NodeJS-SSO</span><span class="sxs-lookup"><span data-stu-id="c9916-118">ssoAuthES6.js in Office-Add-in-NodeJS-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Complete/public/javascripts/ssoAuthES6.js)

### <a name="13000"></a><span data-ttu-id="c9916-119">13000</span><span class="sxs-lookup"><span data-stu-id="c9916-119">13000</span></span>

<span data-ttu-id="c9916-120">加载项或 Office 版本不支持 [getAccessToken](../develop/sso-in-office-add-ins.md#sso-api-reference) API。</span><span class="sxs-lookup"><span data-stu-id="c9916-120">The [getAccessToken](../develop/sso-in-office-add-ins.md#sso-api-reference) API is not supported by the add-in or the Office version.</span></span>

- <span data-ttu-id="c9916-121">Office 版本不支持 SSO。</span><span class="sxs-lookup"><span data-stu-id="c9916-121">The version of Office does not support SSO.</span></span> <span data-ttu-id="c9916-122">在任何月度频道中，所需的版本是 Microsoft 365 订阅。</span><span class="sxs-lookup"><span data-stu-id="c9916-122">The required version is Microsoft 365 subscription, in any monthly channel.</span></span>
- <span data-ttu-id="c9916-123">加载项清单缺少适当的 [WebApplicationInfo](../reference/manifest/webapplicationinfo.md) 部分。</span><span class="sxs-lookup"><span data-stu-id="c9916-123">The add-in manifest is missing the proper [WebApplicationInfo](../reference/manifest/webapplicationinfo.md) section.</span></span>

<span data-ttu-id="c9916-124">加载项应该通过回退到用户身份验证备用系统来响应此错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-124">Your add-in should respond to this error by falling back to an alternate system of user authentication.</span></span> <span data-ttu-id="c9916-125">有关详细信息，请参阅[要求和最佳做法](../develop/sso-in-office-add-ins.md#requirements-and-best-practices)。</span><span class="sxs-lookup"><span data-stu-id="c9916-125">For more information, see [Requirements and Best Practices](../develop/sso-in-office-add-ins.md#requirements-and-best-practices).</span></span>

### <a name="13001"></a><span data-ttu-id="c9916-126">13001</span><span class="sxs-lookup"><span data-stu-id="c9916-126">13001</span></span>

<span data-ttu-id="c9916-127">用户未登录 Office。</span><span class="sxs-lookup"><span data-stu-id="c9916-127">The user is not signed into Office.</span></span> <span data-ttu-id="c9916-128">在大多数情况下，应通过在 `AuthOptions` 参数中传递选项 `allowSignInPrompt: true` 来防止出现此错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-128">In most scenarios, you should prevent this error from ever being seen by passing the option `allowSignInPrompt: true` in the `AuthOptions` parameter.</span></span>

<span data-ttu-id="c9916-129">但是，可能会出现异常情况。</span><span class="sxs-lookup"><span data-stu-id="c9916-129">But there may be exceptions.</span></span> <span data-ttu-id="c9916-130">例如，你希望加载项打开要求用户登录的功能；但*前提*是该用户*已经*登录 Office。</span><span class="sxs-lookup"><span data-stu-id="c9916-130">For example, you want the add-in to open with features that require a logged in user; but *only if* the user is *already* logged into Office.</span></span> <span data-ttu-id="c9916-131">如果用户未登录，则你希望该加载项打开不要求用户登录的备用功能集。</span><span class="sxs-lookup"><span data-stu-id="c9916-131">If the user is not, you want the add-in to open with an alternate set of features that do not require that the user is signed in.</span></span> <span data-ttu-id="c9916-132">在这种情况下，当加载项启动时运行的逻辑将调用不具有 `allowSignInPrompt: true` 的 `getAccessToken`。</span><span class="sxs-lookup"><span data-stu-id="c9916-132">In this case, logic which runs when the add-in launches calls `getAccessToken` without `allowSignInPrompt: true`.</span></span> <span data-ttu-id="c9916-133">使用 13001 错误作为标志，告诉加载项显示备用功能集。</span><span class="sxs-lookup"><span data-stu-id="c9916-133">Use the 13001 error as the flag to tell the add-in to present the alternate set of features.</span></span>

<span data-ttu-id="c9916-134">另一个选项是通过回退到用户身份验证备用系统来响应 13001。</span><span class="sxs-lookup"><span data-stu-id="c9916-134">Another option is to respond to 13001 by falling back to an alternate system of user authentication.</span></span> <span data-ttu-id="c9916-135">这会使用户登录到 AAD，但不会使用户登录到 Office。</span><span class="sxs-lookup"><span data-stu-id="c9916-135">This will sign the user into AAD, but not sign the user into Office.</span></span>

<span data-ttu-id="c9916-136">**Office 网页版**中绝不会出现此错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-136">This error is never seen in **Office on the web**.</span></span> <span data-ttu-id="c9916-137">如果用户的 Cookie 到期，**Office 网页版**将返回错误 13006。</span><span class="sxs-lookup"><span data-stu-id="c9916-137">If the user's cookie expires, **Office on the web** returns error 13006.</span></span>

### <a name="13002"></a><span data-ttu-id="c9916-138">13002</span><span class="sxs-lookup"><span data-stu-id="c9916-138">13002</span></span>

<span data-ttu-id="c9916-139">用户中止登录或同意（例如，在同意对话框中选择**取消**）。</span><span class="sxs-lookup"><span data-stu-id="c9916-139">The user aborted sign in or consent; for example, by choosing **Cancel** on the consent dialog.</span></span>

- <span data-ttu-id="c9916-140">如果加载项提供的功能无需用户登录（或授予许可），代码应捕获此错误，并让加载项继续正常运行。</span><span class="sxs-lookup"><span data-stu-id="c9916-140">If your add-in provides functions that don't require the user to be signed in (or to have granted consent), then your code should catch this error and allow the add-in to stay running.</span></span>
- <span data-ttu-id="c9916-141">如果加载项需要登录用户授予许可，则代码应显示一个登录按钮。</span><span class="sxs-lookup"><span data-stu-id="c9916-141">If the add-in requires a signed-in user who has granted consent, your code should have a sign-in button appear.</span></span>

### <a name="13003"></a><span data-ttu-id="c9916-142">13003</span><span class="sxs-lookup"><span data-stu-id="c9916-142">13003</span></span>

<span data-ttu-id="c9916-143">用户类型不受支持。</span><span class="sxs-lookup"><span data-stu-id="c9916-143">User Type not supported.</span></span> <span data-ttu-id="c9916-144">用户未使用有效的 Microsoft 帐户或 Microsoft 365 教育版或工作帐户登录 Office。</span><span class="sxs-lookup"><span data-stu-id="c9916-144">The user isn't signed into Office with a valid Microsoft account or Microsoft 365 Education or work account.</span></span> <span data-ttu-id="c9916-145">例如，当使用本地域帐户运行 Office 时，可能会生成此错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-145">This may happen if Office runs with an on-premises domain account, for example.</span></span> <span data-ttu-id="c9916-146">代码应回退到用户身份验证备用系统。</span><span class="sxs-lookup"><span data-stu-id="c9916-146">Your code should fall back to an alternate system of user authentication.</span></span> <span data-ttu-id="c9916-147">有关详细信息，请参阅[要求和最佳做法](../develop/sso-in-office-add-ins.md#requirements-and-best-practices)。</span><span class="sxs-lookup"><span data-stu-id="c9916-147">For more information, see [Requirements and Best Practices](../develop/sso-in-office-add-ins.md#requirements-and-best-practices).</span></span>

### <a name="13004"></a><span data-ttu-id="c9916-148">13004</span><span class="sxs-lookup"><span data-stu-id="c9916-148">13004</span></span>

<span data-ttu-id="c9916-149">资源无效。</span><span class="sxs-lookup"><span data-stu-id="c9916-149">Invalid Resource.</span></span> <span data-ttu-id="c9916-150"> (仅应在开发过程中看到此错误。 ) 尚未正确配置加载项清单。</span><span class="sxs-lookup"><span data-stu-id="c9916-150">(This error should only be seen in development.) The add-in manifest hasn't been configured correctly.</span></span> <span data-ttu-id="c9916-151">请更新此清单。</span><span class="sxs-lookup"><span data-stu-id="c9916-151">Update the manifest.</span></span> <span data-ttu-id="c9916-152">有关详细信息，请参阅[验证 Office 加载项的清单](../testing/troubleshoot-manifest.md)。</span><span class="sxs-lookup"><span data-stu-id="c9916-152">For more information, see [Validate an Office Add-in's manifest](../testing/troubleshoot-manifest.md).</span></span> <span data-ttu-id="c9916-153">最常见的问题是**资源**元素（在 **WebApplicationInfo** 元素中）具有与加载项的域不匹配的域。</span><span class="sxs-lookup"><span data-stu-id="c9916-153">The most common problem is that the **Resource** element (in the **WebApplicationInfo** element) has a domain that does not match the domain of the add-in.</span></span> <span data-ttu-id="c9916-154">虽然资源值的协议部分应该是“api”而不是“https”；域名的所有其他部分（包括端口，如果有）应与加载项域名的相应部分相同。</span><span class="sxs-lookup"><span data-stu-id="c9916-154">Although the protocol part of the Resource value should be "api" not "https"; all other parts of the domain name (including port, if any) should be the same as for the add-in.</span></span>

### <a name="13005"></a><span data-ttu-id="c9916-155">13005</span><span class="sxs-lookup"><span data-stu-id="c9916-155">13005</span></span>

<span data-ttu-id="c9916-156">授权无效。</span><span class="sxs-lookup"><span data-stu-id="c9916-156">Invalid Grant.</span></span> <span data-ttu-id="c9916-157">这通常意味着，Office 尚未获得对加载项 Web 服务的预授权。</span><span class="sxs-lookup"><span data-stu-id="c9916-157">This usually means that Office has not been pre-authorized to the add-in's web service.</span></span> <span data-ttu-id="c9916-158">有关详细信息，请参阅[创建服务应用程序](sso-in-office-add-ins.md#create-the-service-application)和[向 Azure AD v2.0 终结点注册加载项](register-sso-add-in-aad-v2.md)。</span><span class="sxs-lookup"><span data-stu-id="c9916-158">For more information, see [Create the service application](sso-in-office-add-ins.md#create-the-service-application) and [Register the add-in with Azure AD v2.0 endpoint](register-sso-add-in-aad-v2.md).</span></span> <span data-ttu-id="c9916-159">如果用户未授权服务应用程序访问其 `profile`，或已吊销许可，也可能会生成此错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-159">This also may happen if the user has not granted your service application permissions to their `profile`, or has revoked consent.</span></span> <span data-ttu-id="c9916-160">代码应回退到用户身份验证备用系统。</span><span class="sxs-lookup"><span data-stu-id="c9916-160">Your code should fall back to an alternate system of user authentication.</span></span>

<span data-ttu-id="c9916-161">另一个可能的原因是，在开发过程中，加载项使用的是 Internet Explorer，并且你使用的是自签名证书。</span><span class="sxs-lookup"><span data-stu-id="c9916-161">Another possible cause, during development, is that your add-in using Internet Explorer, and you are using a self-signed certificate.</span></span> <span data-ttu-id="c9916-162">（若要确定加载项使用的浏览器，请参阅 [Office 加载项使用的浏览器](../concepts/browsers-used-by-office-web-add-ins.md)。）</span><span class="sxs-lookup"><span data-stu-id="c9916-162">(To determine which browser is being used by the add-in, see [Browsers used by Office Add-ins](../concepts/browsers-used-by-office-web-add-ins.md).)</span></span>

### <a name="13006"></a><span data-ttu-id="c9916-163">13006</span><span class="sxs-lookup"><span data-stu-id="c9916-163">13006</span></span>

<span data-ttu-id="c9916-164">客户端错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-164">Client Error.</span></span> <span data-ttu-id="c9916-165">此错误仅出现在 **Office 网页版**中。</span><span class="sxs-lookup"><span data-stu-id="c9916-165">This error is only seen in **Office on the web**.</span></span> <span data-ttu-id="c9916-166">代码应提示用户注销，然后重启 Office 浏览器会话。</span><span class="sxs-lookup"><span data-stu-id="c9916-166">Your code should suggest that the user sign out and then restart the Office browser session.</span></span>

### <a name="13007"></a><span data-ttu-id="c9916-167">13007</span><span class="sxs-lookup"><span data-stu-id="c9916-167">13007</span></span>

<span data-ttu-id="c9916-168">Office 应用程序无法获取对外接程序的 web 服务的访问令牌。</span><span class="sxs-lookup"><span data-stu-id="c9916-168">The Office application was unable to get an access token to the add-in's web service.</span></span>

- <span data-ttu-id="c9916-169">如果在开发过程中发生此错误，请确保加载项注册和加载项清单指定 `profile` 权限（和 `openid` 权限 - 如果你使用的是 MSAL.NET）。</span><span class="sxs-lookup"><span data-stu-id="c9916-169">If this error occurs during development, be sure that your add-in registration and add-in manifest specify the `profile` permission (and the `openid` permission, if you are using MSAL.NET).</span></span> <span data-ttu-id="c9916-170">如需了解更多信息，请参阅[向 Azure AD v2.0 终结点注册加载项](register-sso-add-in-aad-v2.md)。</span><span class="sxs-lookup"><span data-stu-id="c9916-170">For more information, see [Register the add-in with Azure AD v2.0 endpoint](register-sso-add-in-aad-v2.md).</span></span>
- <span data-ttu-id="c9916-171">在生产中，有几种情况可能导致此错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-171">In production, there are several things that can cause this error.</span></span> <span data-ttu-id="c9916-172">其中一些是：</span><span class="sxs-lookup"><span data-stu-id="c9916-172">Some of them are:</span></span>
    - <span data-ttu-id="c9916-173">用户拥有 Microsoft 帐户标识。</span><span class="sxs-lookup"><span data-stu-id="c9916-173">The user has a Microsoft account identity.</span></span>
    - <span data-ttu-id="c9916-174">在使用 MSA 时，某些会导致 Microsoft 365 教育版或工作帐户出现其他13xxx 错误的情况将导致13007。</span><span class="sxs-lookup"><span data-stu-id="c9916-174">Some situations that would cause one of the other 13xxx errors with a Microsoft 365 Education or work account will cause a 13007 when a MSA is used.</span></span>

  <span data-ttu-id="c9916-175">对于所有这些情况，代码应回退到用户身份验证备用系统。</span><span class="sxs-lookup"><span data-stu-id="c9916-175">For all of these cases, your code should fall back to an alternate system of user authentication.</span></span>

### <a name="13008"></a><span data-ttu-id="c9916-176">13008</span><span class="sxs-lookup"><span data-stu-id="c9916-176">13008</span></span>

<span data-ttu-id="c9916-177">用户在上一次调用 `getAccessToken` 完成前触发了调用 `getAccessToken` 的操作。</span><span class="sxs-lookup"><span data-stu-id="c9916-177">The user triggered an operation that calls `getAccessToken` before a previous call of `getAccessToken` completed.</span></span> <span data-ttu-id="c9916-178">此错误仅出现在 **Office 网页版**中。</span><span class="sxs-lookup"><span data-stu-id="c9916-178">This error is only seen on **Office on the web**.</span></span> <span data-ttu-id="c9916-179">代码应提示用户在上一次操作完成后再重复此操作。</span><span class="sxs-lookup"><span data-stu-id="c9916-179">Your code should ask the user to repeat the operation after the previous operation has completed.</span></span>

### <a name="13010"></a><span data-ttu-id="c9916-180">13010</span><span class="sxs-lookup"><span data-stu-id="c9916-180">13010</span></span>

<span data-ttu-id="c9916-181">用户正在 Microsoft Edge 或 Internet Explorer 上的 Office 中运行加载项。</span><span class="sxs-lookup"><span data-stu-id="c9916-181">The user is running the add-in in Office on Microsoft Edge or Internet Explorer.</span></span> <span data-ttu-id="c9916-182">用户的 Microsoft 365 域和 `login.microsoftonline.com` 域在浏览器设置中位于不同的安全区域中。</span><span class="sxs-lookup"><span data-stu-id="c9916-182">The user's Microsoft 365 domain, and the `login.microsoftonline.com` domain, are in a different security zones in the browser settings.</span></span> <span data-ttu-id="c9916-183">此错误仅出现在 **Office 网页版**中。</span><span class="sxs-lookup"><span data-stu-id="c9916-183">This error is only seen on **Office on the web**.</span></span> <span data-ttu-id="c9916-184">如果此错误返回，用户将已看到对此进行解释的错误，并链接到关于如何更改区域配置的页面。</span><span class="sxs-lookup"><span data-stu-id="c9916-184">If this error is returned, the user will have already seen an error explaining this and linking to a page about how to change the zone configuration.</span></span> <span data-ttu-id="c9916-185">如果加载项提供的功能无需用户登录，代码应捕获此错误，并让加载项继续正常运行。</span><span class="sxs-lookup"><span data-stu-id="c9916-185">If your add-in provides functions that don't require the user to be signed in, then your code should catch this error and allow the add-in to stay running.</span></span>

### <a name="13012"></a><span data-ttu-id="c9916-186">13012</span><span class="sxs-lookup"><span data-stu-id="c9916-186">13012</span></span>

<span data-ttu-id="c9916-187">存在几种可能的原因：</span><span class="sxs-lookup"><span data-stu-id="c9916-187">There are several possible causes:</span></span>

- <span data-ttu-id="c9916-188">加载项在不支持 `getAccessToken` API的平台上运行。</span><span class="sxs-lookup"><span data-stu-id="c9916-188">The add-in is running on a platform that does not support the `getAccessToken` API.</span></span> <span data-ttu-id="c9916-189">例如，在 iPad 上它不受支持。</span><span class="sxs-lookup"><span data-stu-id="c9916-189">For example, it is not supported on iPad.</span></span> <span data-ttu-id="c9916-190">另请参阅[标识 API 要求集](../reference/requirement-sets/identity-api-requirement-sets.md)。</span><span class="sxs-lookup"><span data-stu-id="c9916-190">See also [Identity API Requirement Sets](../reference/requirement-sets/identity-api-requirement-sets.md).</span></span>
- <span data-ttu-id="c9916-191">`forMSGraphAccess` 选项在调用中传递给 `getAccessToken`，并且用户从 AppSource 获得了加载项。</span><span class="sxs-lookup"><span data-stu-id="c9916-191">The `forMSGraphAccess` option was passed in the call to `getAccessToken` and the user obtained the add-in from AppSource.</span></span> <span data-ttu-id="c9916-192">在此方案中，对于所需的 Microsoft Graph 范围（权限），租户管理员未向加载项授予许可。</span><span class="sxs-lookup"><span data-stu-id="c9916-192">In this scenario, the tenant admin has not granted consent to the add-in for the Microsoft Graph scopes (permissions) that it needs.</span></span> <span data-ttu-id="c9916-193">撤回具有 `allowConsentPrompt` 的 `getAccessToken` 将无法解决此问题，因为允许 Office 提示用户仅同意 AAD `profile` 范围。</span><span class="sxs-lookup"><span data-stu-id="c9916-193">Recalling `getAccessToken` with the `allowConsentPrompt` will not solve the problem because Office is allowed to prompt the user for consent to only the AAD `profile` scope.</span></span>

<span data-ttu-id="c9916-194">代码应回退到用户身份验证备用系统。</span><span class="sxs-lookup"><span data-stu-id="c9916-194">Your code should fall back to an alternate system of user authentication.</span></span>

<span data-ttu-id="c9916-195">在开发中，该加载项在 Outlook 中旁加载，并且在 `getAccessToken` 调用中传递了 `forMSGraphAccess` 选项。</span><span class="sxs-lookup"><span data-stu-id="c9916-195">In development, the add-in is sideloaded in Outlook and the `forMSGraphAccess` option was passed in the call to `getAccessToken`.</span></span>

### <a name="13013"></a><span data-ttu-id="c9916-196">13013</span><span class="sxs-lookup"><span data-stu-id="c9916-196">13013</span></span>

<span data-ttu-id="c9916-197">`getAccessToken`在短时间内调用次数过多，因此 Office 限制了最近的呼叫。</span><span class="sxs-lookup"><span data-stu-id="c9916-197">The `getAccessToken` was called too many times in a short amount of time, so Office throttled the most recent call.</span></span> <span data-ttu-id="c9916-198">这通常是由对方法的调用的无限循环引起的。</span><span class="sxs-lookup"><span data-stu-id="c9916-198">This is usually caused by an infinite loop of calls to the method.</span></span> <span data-ttu-id="c9916-199">在某些情况下，建议撤回该方法。</span><span class="sxs-lookup"><span data-stu-id="c9916-199">There are scenarios when recalling the method is advisable.</span></span> <span data-ttu-id="c9916-200">但是，您的代码应使用计数器或标志变量以确保不会重复回调该方法。</span><span class="sxs-lookup"><span data-stu-id="c9916-200">However, your code should use a counter or flag variable to ensure that the method is not recalled repeatedly.</span></span> <span data-ttu-id="c9916-201">如果相同的 "重试" 代码路径再次运行，则代码应回退到用户身份验证的备用系统。</span><span class="sxs-lookup"><span data-stu-id="c9916-201">If the same "retry" code path is running again, the code should fall back to an alternate system of user authentication.</span></span> <span data-ttu-id="c9916-202">有关代码示例，请参阅如何 `retryGetAccessToken` 在 [HomeES6.js](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/HomeES6.js) 或 [ssoAuthES6.js](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Complete/public/javascripts/ssoAuthES6.js)中使用变量。</span><span class="sxs-lookup"><span data-stu-id="c9916-202">For a code example, see how the `retryGetAccessToken` variable is used in [HomeES6.js](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO/blob/master/Complete/Office-Add-in-ASPNET-SSO-WebAPI/Scripts/HomeES6.js) or [ssoAuthES6.js](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO/blob/master/Complete/public/javascripts/ssoAuthES6.js).</span></span>

### <a name="50001"></a><span data-ttu-id="c9916-203">50001</span><span class="sxs-lookup"><span data-stu-id="c9916-203">50001</span></span>

<span data-ttu-id="c9916-204">此错误（未特定于 `getAccessToken`）可能表示浏览器已缓存 office.js 文件的旧副本。</span><span class="sxs-lookup"><span data-stu-id="c9916-204">This error (which is not specific to `getAccessToken`) may indicate that the browser has cached an old copy of the office.js files.</span></span> <span data-ttu-id="c9916-205">在开发时，清除浏览器的缓存。</span><span class="sxs-lookup"><span data-stu-id="c9916-205">When you are developing, clear the browser's cache.</span></span> <span data-ttu-id="c9916-206">另一种可能是 Office 的版本不够新，不足以支持 SSO。</span><span class="sxs-lookup"><span data-stu-id="c9916-206">Another possibility is that the version of Office is not recent enough to support SSO.</span></span> <span data-ttu-id="c9916-207">在 Windows 上，最低版本是 16.0.12215.20006。</span><span class="sxs-lookup"><span data-stu-id="c9916-207">On Windows, the minimum version is 16.0.12215.20006.</span></span> <span data-ttu-id="c9916-208">在 Mac 上，它是 16.32.19102902。</span><span class="sxs-lookup"><span data-stu-id="c9916-208">On Mac, it is 16.32.19102902.</span></span>

<span data-ttu-id="c9916-209">在生产加载项中，加载项应该通过回退到用户身份验证备用系统来响应此错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-209">In a production add-in, the add-in should respond to this error by falling back to an alternate system of user authentication.</span></span> <span data-ttu-id="c9916-210">有关详细信息，请参阅[要求和最佳做法](../develop/sso-in-office-add-ins.md#requirements-and-best-practices)。</span><span class="sxs-lookup"><span data-stu-id="c9916-210">For more information, see [Requirements and Best Practices](../develop/sso-in-office-add-ins.md#requirements-and-best-practices).</span></span>

## <a name="errors-on-the-server-side-from-azure-active-directory"></a><span data-ttu-id="c9916-211">Azure Active Directory 服务器端错误</span><span class="sxs-lookup"><span data-stu-id="c9916-211">Errors on the server-side from Azure Active Directory</span></span>

<span data-ttu-id="c9916-212">有关此部分中介绍的错误处理示例，请参阅：</span><span class="sxs-lookup"><span data-stu-id="c9916-212">For samples of the error-handling described in this section, see:</span></span>
- [<span data-ttu-id="c9916-213">Office-Add-in-ASPNET-SSO</span><span class="sxs-lookup"><span data-stu-id="c9916-213">Office-Add-in-ASPNET-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-ASPNET-SSO)
- [<span data-ttu-id="c9916-214">Office-Add-in-NodeJS-SSO</span><span class="sxs-lookup"><span data-stu-id="c9916-214">Office-Add-in-NodeJS-SSO</span></span>](https://github.com/OfficeDev/Office-Add-in-NodeJS-SSO)

### <a name="conditional-access--multifactor-authentication-errors"></a><span data-ttu-id="c9916-215">条件访问/多重身份验证错误</span><span class="sxs-lookup"><span data-stu-id="c9916-215">Conditional access / Multifactor authentication errors</span></span>

<span data-ttu-id="c9916-216">在 AAD 和 Microsoft 365 中的某些标识配置中，Microsoft Graph 可访问的某些资源可能需要多重身份验证 (MFA) ，即使用户的 Microsoft 365 租赁不是这样的。</span><span class="sxs-lookup"><span data-stu-id="c9916-216">In certain configurations of identity in AAD and Microsoft 365, it is possible for some resources that are accessible with Microsoft Graph to require multifactor authentication (MFA), even when the user's Microsoft 365 tenancy does not.</span></span> <span data-ttu-id="c9916-217">通过代表流收到对 MFA 保护资源的令牌请求时，AAD 会向加载项 Web 服务返回包含 `claims` 属性的 JSON 消息。</span><span class="sxs-lookup"><span data-stu-id="c9916-217">When AAD receives a request for a token to the MFA-protected resource, via the on-behalf-of flow, it returns to your add-in's web service a JSON message that contains a `claims` property.</span></span> <span data-ttu-id="c9916-218">claims 属性指明需要进一步执行哪几重身份验证。</span><span class="sxs-lookup"><span data-stu-id="c9916-218">The claims property has information about what further authentication factors are needed.</span></span>

<span data-ttu-id="c9916-219">代码应对此 `claims` 属性进行测试。</span><span class="sxs-lookup"><span data-stu-id="c9916-219">Your code should test for this `claims` property.</span></span> <span data-ttu-id="c9916-220">根据加载项的体系结构，你可以在客户端进行测试，也可以在服务器端进行测试并将其中继到客户端。</span><span class="sxs-lookup"><span data-stu-id="c9916-220">Depending on your add-in's architecture, you may test for it on the client-side, or you may test for it on the server-side and relay it to the client.</span></span> <span data-ttu-id="c9916-221">客户端需要此信息，因为 Office 处理 SSO 加载项的身份验证。如果从服务器端进行中继，则发送到客户端的消息可以是错误（如 `500 Server Error` 或 `401 Unauthorized`），也可以是成功响应的正文部分（如 `200 OK`）。</span><span class="sxs-lookup"><span data-stu-id="c9916-221">You need this information in the client because Office handles authentication for SSO add-ins. If you relay it from the server-side, the message to the client can be either an error (such as `500 Server Error` or `401 Unauthorized`) or in the body of a success response (such as `200 OK`).</span></span> <span data-ttu-id="c9916-222">无论属于上述哪种情况，代码对加载项 Web API 的客户端 AJAX 调用的（失败或成功）回调都应测试此响应是否有错。</span><span class="sxs-lookup"><span data-stu-id="c9916-222">In either case, the (failure or success) callback of your code's client-side AJAX call to your add-in's web API should test for this response.</span></span> 

<span data-ttu-id="c9916-223">无论采用何种体系结构，如果声明值已从 AAD 发送，则代码应重新调用 `getAccessToken` 并 `authChallenge: CLAIMS-STRING-HERE` 在参数中传递选项 `options` 。</span><span class="sxs-lookup"><span data-stu-id="c9916-223">Regardless of your architecture, if the claims value has been sent from AAD, your code should recall `getAccessToken` and pass the option `authChallenge: CLAIMS-STRING-HERE` in the `options` parameter.</span></span> <span data-ttu-id="c9916-224">如果 AAD 看到此字符串，它会先提示用户进行多重身份验证，再返回将在代表流中接受的新访问令牌。</span><span class="sxs-lookup"><span data-stu-id="c9916-224">When AAD sees this string, it prompts the user for the additional factor(s) and then returns a new access token which will be accepted in the on-behalf-of flow.</span></span>

### <a name="consent-missing-errors"></a><span data-ttu-id="c9916-225">缺少许可错误</span><span class="sxs-lookup"><span data-stu-id="c9916-225">Consent missing errors</span></span>

<span data-ttu-id="c9916-226">如果 AAD 未记录用户（或租户管理员）已授权加载项访问 Microsoft Graph 资源，AAD 会向 Web 服务发送错误消息。</span><span class="sxs-lookup"><span data-stu-id="c9916-226">If AAD has no record that consent (to the Microsoft Graph resource) was granted to the add-in by the user (or tenant administrator), AAD will send an error message to your web service.</span></span> <span data-ttu-id="c9916-227">代码必须指示客户端（例如，在 `403 Forbidden` 响应的正文中）。</span><span class="sxs-lookup"><span data-stu-id="c9916-227">Your code must tell the client (in the body of a `403 Forbidden` response, for example).</span></span>

<span data-ttu-id="c9916-228">如果加载项需要只能由管理员许可的 Microsoft Graph 范围，则代码应该会引发错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-228">If the add-in needs Microsoft Graph scopes that can only be consented to by an admin, your code should throw an error.</span></span> <span data-ttu-id="c9916-229">如果用户只能许可所需的范围，则代码应回退到用户身份验证备用系统。</span><span class="sxs-lookup"><span data-stu-id="c9916-229">If the only scopes that are needed can be consented to by the user, then your code should fall back to an alternate system of user authentication.</span></span>

### <a name="invalid-or-missing-scope-permission-errors"></a><span data-ttu-id="c9916-230">范围（权限）无效或缺失错误</span><span class="sxs-lookup"><span data-stu-id="c9916-230">Invalid or missing scope (permission) errors</span></span>

<span data-ttu-id="c9916-231">应该只会在开发中看到此类错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-231">This kind of error should only be seen in development.</span></span>

- <span data-ttu-id="c9916-232">服务器端代码应向客户端发送 `403 Forbidden` 响应，它应该会在控制台或日志中记录此错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-232">Your server-side code should send a `403 Forbidden` response to the client which should log the error to the console or record it in a log.</span></span>
- <span data-ttu-id="c9916-233">请确保加载项清单 [Scopes](../reference/manifest/scopes.md) 部分指定了所需的全部权限。</span><span class="sxs-lookup"><span data-stu-id="c9916-233">Be sure your add-in manifest [Scopes](../reference/manifest/scopes.md) section specifies all needed permissions.</span></span> <span data-ttu-id="c9916-234">此外，还请确保加载项 Web 服务注册指定了相同的权限。</span><span class="sxs-lookup"><span data-stu-id="c9916-234">And be sure your registration of the add-in's web service specifies the same permissions.</span></span> <span data-ttu-id="c9916-235">同时检查是否有拼写错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-235">Check for spelling mistakes too.</span></span> <span data-ttu-id="c9916-236">如需了解更多信息，请参阅[向 Azure AD v2.0 终结点注册加载项](register-sso-add-in-aad-v2.md)。</span><span class="sxs-lookup"><span data-stu-id="c9916-236">For more information, see [Register the add-in with Azure AD v2.0 endpoint](register-sso-add-in-aad-v2.md).</span></span>

### <a name="invalid-audience-error-in-the-access-token-not-the-bootstrap-token"></a><span data-ttu-id="c9916-237">访问令牌（而非启动令牌）中的无效受众错误</span><span class="sxs-lookup"><span data-stu-id="c9916-237">Invalid audience error in the access token (not the bootstrap token)</span></span>

<span data-ttu-id="c9916-238">服务器端代码应向客户端发送 `403 Forbidden` 响应，向用户显示易记消息，并尽可能在控制台或日志中记录此错误。</span><span class="sxs-lookup"><span data-stu-id="c9916-238">Your server-side code should send a `403 Forbidden` response to the client which should present a friendly message to the user and possibly also log the error to the console or record it in a log.</span></span>
