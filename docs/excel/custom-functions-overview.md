# <a name="create-custom-functions-in-excel-preview"></a>? Excel ????????????

?????????????????? [UDF]??????????????? Excel ???? JavaScript ??? ?????????? Excel ???????????????????? `=SUM()`?? ???????? Excel ?????????

????????????????????????? ? 42 ???????????

<img alt="custom functions" src="../images/custom-function.gif" width="579" height="383" />

??????????????

```js
function ADD42(a, b) {
    return a + b + 42;
}
```

???????? Windows?Mac ? Excel Online ???????????? ???????????????

1.  ?? Office?Windows ????? 9325 ? Mac ?????? 13.329???? [Office ??????](https://products.office.com/en-us/office-insider)??? ????????????????????????????????????????????
2.  ?? [Excel-Custom-Functions](https://github.com/OfficeDev/Excel-Custom-Functions) ??????? README.md ????? Excel ??????????????????
3.  ????????? `=CONTOSO.ADD42(1,2)`??? **Enter** ????????

????????**????**??????????????????????????????

## <a name="learn-the-basics"></a>??????

???????????????????

- **customfunctions.js**????????????????????????? `ADD42` ????
- **customfunctions.json**???????JSON???Excel???????? ????????????????????????????????
- **customfunctions.html**??????? &lt;??&gt; ??JS??? ????? Excel ??? UI?
- **customfunctions.xml**????Excel HTML?JavaScript?JSON?????;????????????????????????????

### <a name="json-file-customfunctionsjson"></a>JSON???customfunctions.json?

customfunctions.json????????? `ADD42` ????????

> [!NOTE]
> JSON????????????????????????? [???????JSON](https://dev.office.com/reference/add-ins/custom-functions-json)?

???????????

- ?????????????? `functions` ????????
- ? `name` ?????????? ?????????gif??????????`CONTOSO`??????Excel????????????? ?????????????????? ????????????????????????????? ???????????????????????????`ADD42`??????????????? `=CONTOSO.ADD42`? ????????????????? 
- `description` ?? Excel ???????????
- ???????????????Excel ?????????????`helpUrl`?? URL ????
- ? `result` ?????????Excel??????? ? `type` ????? `"string"`? `"number"`? ? `"boolean"`? ? `dimensionality` ???? `scalar` ? `matrix` ??? `type`????????
- ? `parameters` ?? *???*???????????????????? ? `name` ? `description` ?Excel??????????? ? `type` ? `dimensionality` ?????? `result` ?????????
- ? `options` ?????????Excel???????????????? ?????????????????

 ```js
{
    "$schema": "https://developer.microsoft.com/en-us/json-schemas/office-js/custom-functions.schema.json",
    "functions": [
        {
            "name": "ADD42", 
            "description":  "adds 42 to the input numbers",
            "helpUrl": "http://dev.office.com",
            "result": {
                "type": "number",
                "dimensionality": "scalar"
            },
            "parameters": [
                {
                    "name": "number 1",
                    "description": "the first number to be added",
                    "type": "number",
                    "dimensionality": "scalar"
                },
                {
                    "name": "number 2",
                    "description": "the second number to be added",
                    "type": "number",
                    "dimensionality": "scalar"
                }
            ],
            "options": {
                "sync": true
            }
        }
    ]
}
```

> [!NOTE]
> ?????????????????????? ????????????????????????????????????????

??JSON???????????? [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS) ??????????Excel Online??????


### <a name="manifest-file-customfunctionsxml"></a>?????customfunctions.xml?


??????? `<ExtensionPoint>` ? `<Resources>` ???????????????Excel????????? ??????????????

- ? `<Script>` ?????????ID??JavaScript????????????
- ? `<Page>` ?????????ID??????HTML?????? HTML?????? `<Script>` ??JavaScript??????customfunctions.js?? HTML ??????????????? UI ????
- ? `<Metadata>` ?????????ID??JSON??????
- ?? `<Namespace>` ?????????ID?????????????????


```xml
<VersionOverrides xmlns="http://schemas.microsoft.com/office/taskpaneappversionoverrides" xsi:type="VersionOverridesV1\_0">
    <Hosts>
        <Host xsi:type="Workbook">
            <AllFormFactors>
                <ExtensionPoint xsi:type="CustomFunctions">
                    <Script>
                        <SourceLocation resid="residjs" />
                    </Script>
                    <Page>
                        <SourceLocation resid="residhtml"/>
                    </Page>
                    <Metadata>
                        <SourceLocation resid="residjson" />
                    </Metadata>
                    <Namespace resid="residNS" />
                </ExtensionPoint>
            </AllFormFactors>
        </Host>
    </Hosts>
    <Resources>
        <bt:Urls>
            <bt:Url id="residjson" DefaultValue="http://127.0.0.1:8080/customfunctions.json" />
            <bt:Url id="residjs" DefaultValue="http://127.0.0.1:8080/customfunctions.js" />
            <bt:Url id="residhtml" DefaultValue="http://127.0.0.1:8080/customfunctions.html" />
        </bt:Urls>
        <bt:ShortStrings>
            <bt:String id="residNS" DefaultValue="CONTOSO" />
        </bt:ShortStrings>
    </Resources>
</VersionOverrides>

```

## <a name="initializing-custom-functions"></a>????????

?????????????????????? ?????? &lt;??&gt; ?HTML???customfunctions.html??????JavaScript???customfunctions.js????? ???????????????????????? ?????HTML?????????

```js
Office.initialize = function (reason) {
    return Excel.CustomFunctions.initialize();
};
```

???????????

```js
Office.Preview.StartCustomFunctions();
```

## <a name="synchronous-and-asynchronous-functions"></a>???????

??? `ADD42` ?????Excel?????????JSON???? `"sync": true` ??????? ??????????????????Excel??????????????????????????   

???????????????Web?????????????Excel??? ???????

1. ? JavaScript ????? Excel?
3. ?????????????Promise?

??????????????????????????? ?? `sendWebRequest` ???????????????????XHR??????????

```js
function getTemperature(thermometerID){
    return new OfficeExtension.Promise(function(setResult){
        sendWebRequest(thermometerID, function(data){
            setResult(data.temperature);
        });
    });
}
```

???????Excel????????????????? `GETTING_DATA` ????? ???????????????????????????

> [!NOTE]
> ???????????? ???????????? `"sync": true` ?????JSON????????? `options` ????

## <a name="streamed-functions"></a>??????

??????????? ??????????????????????????????????? Excel ?????????? ?????????????????????????? ??????????????


- Excel????? `setResult` ??????????
- ???????????????? `caller`?????????????????? Excel ????????????? ????`setResult` ??????????????????? Excel?????????
- ???Excel?? `setResult` ??? `caller` ?????????? `"stream": true` ?????JSON????????? `options` ?????????????????????

```js
function incrementValue(increment, caller){
    var result = 0;
    setInterval(function(){
         result += increment;
         caller.setResult(result);
    }, 1000);
}
```

## <a name="cancellation"></a>??

???????????????? ?????????????? CPU ?????????????? Excel ?????????????

- ????????????????
- ???????????????? ?????????????????????????
- ?????????????????????????????????????

? *??* ?????????????????? ??????????????????????? ?????????

????????????? `"cancelable": true` ???JSON????????? `options` ?????

???????????????????? ??????`caller` ????????????????????? `onCanceled` ???

```js
function incrementValue(increment, caller){ 
    var result = 0;
    var timer = setInterval(function(){
         result += increment;
         caller.setResult(result);
    }, 1000);

    caller.onCanceled = function(){
        clearInterval(timer);
    }
}
```

## <a name="saving-and-sharing-state"></a>???????

????????????????? JavaScript ???? ??????????????????????????? ????????????????????????????????????????????????? ??????????? Web ??????????????????? Web ???

???????????????????????????????????? ??????????????


- `refreshTemperature` ??????????????????????????? ??????? `savedTemperatures` ?????????????? ????????????????? *??????JSON?????*?
- `streamTemperature` ?????????????????? `savedTemperatures` ????????? ????JSON????????????????? `STREAMTEMPERATURE`?
- ????? Excel UI ????????? `streamTemperature`? ????????? `savedTemperatures` ???????

```js
var savedTemperatures;

function streamTemperature(thermometerID, caller){ 
     if(!savedTemperatures[thermometerID]){
         refreshTemperatures(thermometerID); // starts fetching temperatures if the thermometer hasn't been read yet
     }

     function getNextTemperature(){
         caller.setResult(savedTemperatures[thermometerID]); // setResult sends the saved temperature value to Excel.
         setTimeout(getNextTemperature, 1000); // Wait 1 second before updating Excel again.
     }
     getNextTemperature();
}

function refreshTemperature(thermometerID){
     sendWebRequest(thermometerID, function(data){
         savedTemperatures[thermometerID] = data.temperature;
     });
     setTimeout(function(){
         refreshTemperature(thermometerID);
     }, 1000); // Wait 1 second before reading the thermometer again, and then update the saved temperature of thermometerID.
}
```

> [!NOTE]
> ????????JSON????? `"sync": true` ??????????????Excel???????????????? ??????????????????????????????????JavaScript????

## <a name="working-with-ranges-of-data"></a>??????

??????????????????????????????????

???????????Excel??????????????? ??????????? `values`?? `Excel.CustomFunctionDimensionality.matrix` ????? ???????????JSON?????????? `type` ??? `matrix`?

```js
function secondHighest(values){ 
     var highest = values[0][0], secondHighest = values[0][0];
     for(var i = 0; i < values.length; i++){
         for(var j = 1; j < values[i].length; j++){
             if(values[i][j] >= highest){
                 secondHighest = highest;
                 highest = values[i][j];
             }
             else if(values[i][j] >= secondHighest){
                 secondHighest = values[i][j];
             }
         }
     }
     return secondHighest;
 }
```

????????JavaScript??????????2???????

## <a name="known-issues"></a>????

- Excel ?????? URL ??????
- ????????????????Excel?
- ??????????????????????????? ???JavaScript ??????????????????????????????????? ???????????????? `<Page>` ?????? HTML ????? Excel ????? JavaScript? ???????????????????????? DOM? ??GET?POST?????????????APIs??? [WebSocket](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API) ? [XHR](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) ?
- ??????????????????????????????????????
- ??????Excel for Windows???????
- ??????Office 365?????AppSource??????
- Excel Online??????????????????????????????? ????????F5??????????????????

## <a name="changelog"></a>????

- **2017 ? 11 ? 7 ?**????????????????
- **2017 ? 11 ? 20 ?**?????????? 8801 ??????????????
- **2017?11?28?**?????????????????????????????
- **2018?5?7?**????Mac?Excel Online??????????????
